---
phase: 04-protocol-specification-and-connection-broker
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - spec/handshake.md
  - spec/identity.md
  - spec/message.md
  - spec/consent.md
  - spec/credential.md
autonomous: true
requirements: [PROT-01, PROT-04, PROT-05]

must_haves:
  truths:
    - "Five spec documents exist in spec/ that describe the implemented protocol behavior"
    - "The handshake spec documents the AxonBroker.connect() pipeline including all denial codes and the grant response format"
    - "The identity spec documents Ed25519 key format, base64url wire encoding, and JWK import pattern compatible with Neuron"
    - "The consent spec describes the consent token format (Neuron's implementation) without prescribing Axon behavior -- Axon never touches consent"
    - "The credential spec documents the CredentialRecord schema matching the existing registry implementation"
  artifacts:
    - path: "spec/handshake.md"
      provides: "Handshake flow specification"
      contains: "connect_request"
    - path: "spec/identity.md"
      provides: "Ed25519 identity and wire format specification"
      contains: "Ed25519"
    - path: "spec/message.md"
      provides: "Message format and validation specification"
      contains: "ConnectRequest"
    - path: "spec/consent.md"
      provides: "Consent token format specification (descriptive)"
      contains: "consent"
    - path: "spec/credential.md"
      provides: "Credential format specification"
      contains: "CredentialRecord"
  key_links:
    - from: "spec/handshake.md"
      to: "src/broker/broker.ts"
      via: "Documents the implemented connect() pipeline"
      pattern: "connect_grant|connect_denial"
    - from: "spec/identity.md"
      to: "src/protocol/identity.ts"
      via: "Documents the key format and signing operations"
      pattern: "base64url"
    - from: "spec/credential.md"
      to: "src/registry/schemas.ts"
      via: "Documents the CredentialRecord schema"
      pattern: "CredentialRecord"
---

<objective>
Write five protocol specification documents that describe the implemented behavior from Plans 01 and 02.

Purpose: These specs serve as the canonical reference for CareAgent ecosystem developers (provider-core, patient-core, neuron teams) building against Axon's protocol. Written code-first to prevent spec-code drift -- each document describes what the code actually does.

Output: Five markdown documents in `spec/` directory: handshake.md, identity.md, message.md, consent.md, credential.md.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-protocol-specification-and-connection-broker/04-RESEARCH.md
@.planning/phases/04-protocol-specification-and-connection-broker/04-CONTEXT.md
@.planning/phases/04-protocol-specification-and-connection-broker/04-01-SUMMARY.md
@.planning/phases/04-protocol-specification-and-connection-broker/04-02-SUMMARY.md
@src/protocol/identity.ts
@src/protocol/schemas.ts
@src/protocol/nonce.ts
@src/protocol/errors.ts
@src/broker/audit.ts
@src/broker/broker.ts
@src/registry/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write handshake, identity, and message spec documents</name>
  <files>
    spec/handshake.md
    spec/identity.md
    spec/message.md
  </files>
  <action>
Create the `spec/` directory if it doesn't exist.

Per CONTEXT.md: primary audience is internal CareAgent developers. Use narrative style with structured headings (Wire Format, Validation Rules, Error Cases) and inline TypeScript code examples. Assumes reader knows the CareAgent ecosystem.

**spec/handshake.md** -- The primary spec document. Sections:
1. **Overview**: Axon's handshake is a single synchronous `connect()` call. Patient CareAgent initiates. Axon checks credentials and endpoint status, then grants or denies. After a grant, the patient CareAgent connects directly to the Neuron at the returned endpoint for the full multi-step handshake (challenge-response, consent verification, relationship creation). Axon is NOT involved after the grant.
2. **Handshake Flow**: Step-by-step pipeline: (1) patient constructs ConnectRequest, (2) patient signs payload with Ed25519 private key, (3) patient sends SignedMessage to Axon broker, (4) broker validates signature, (5) broker checks nonce/timestamp, (6) broker looks up provider credentials, (7) broker resolves Neuron endpoint, (8) broker grants or denies. Include a simple diagram (ASCII art or numbered steps).
3. **Request Format**: Reference `spec/message.md` for ConnectRequest schema. Show how to construct and sign a request with TypeScript example.
4. **Grant Response**: `ConnectGrant` fields: `type`, `connection_id`, `provider_npi`, `neuron_endpoint`, `protocol_version`. The `connection_id` is for audit trail correlation (both Axon and Neuron can use it). The `neuron_endpoint` is where the patient CareAgent connects next.
5. **Denial Response**: `ConnectDenial` fields: `type`, `connection_id`, `code`, `message`. Document all 6 denial codes with their categorical meanings. Note: specific details (which credential expired, when heartbeat was last seen) are logged to the audit trail only, not returned to the caller (security: prevent information leakage).
6. **Post-Handshake**: After receiving a grant, the patient CareAgent connects to the Neuron endpoint to begin the Neuron-level handshake (HANDSHAKE_INIT -> CHALLENGE -> CHALLENGE_RESPONSE -> HANDSHAKE_COMPLETE). Reference the Neuron handshake sequence from CONTEXT.md. Axon has no involvement in this phase.
7. **Audit Trail**: Every connect attempt generates audit events (connect_attempt + connect_granted/connect_denied). Hash-chained JSONL format. No clinical content.
8. **Design Principles**: Stateless (no session state), atomic (every connect() is complete), patient-initiated, credentials-only (no consent verification).

**spec/identity.md** -- Ed25519 identity specification. Sections:
1. **Overview**: All Axon protocol identities use Ed25519 key pairs. Keys are represented as base64url-encoded raw 32-byte values.
2. **Key Format**: Public key is the `x` component from JWK export. Private key is the `d` component. Both are 43 base64url characters (32 bytes). Show the JWK structure: `{ kty: 'OKP', crv: 'Ed25519', x: '<base64url>' }` for public, add `d` for private.
3. **Key Generation**: TypeScript example using `generateKeyPairSync('ed25519')` with JWK export.
4. **Signing**: Sign with `crypto.sign(null, data, privateKey)`. The `null` algorithm is required for Ed25519 (NOT `createSign`). Signature is 64 bytes (86 base64url characters). TypeScript example.
5. **Verification**: Verify with `crypto.verify(null, data, publicKey, signature)`. TypeScript example.
6. **Wire Format**: All keys and signatures on the wire use base64url encoding (RFC 4648, no padding). Character set: `[A-Za-z0-9_-]`. Standard base64 (`+/=`) is NOT used.
7. **Neuron Compatibility**: Axon's key format is compatible with Neuron's JWK import: `{ kty: 'OKP', crv: 'Ed25519', x: publicKey }`. This ensures keys generated by Axon or Neuron are interoperable.
8. **Security Notes**: Ed25519 is deterministic (no random nonce in signing), 128-bit security level, resistant to timing attacks. All crypto operations use `node:crypto` (FIPS-compliant).

**spec/message.md** -- Protocol message format. Sections:
1. **Overview**: Axon protocol uses versioned, signed messages with replay protection.
2. **ConnectRequest Schema**: Full field-by-field documentation with types, constraints, and examples. Version field enables future protocol evolution.
3. **SignedMessage Envelope**: `{ payload: base64url(JSON), signature: base64url(sig) }`. The payload is the base64url encoding of the ConnectRequest JSON string. The signature is computed over the original JSON bytes (before base64url encoding). Include TypeScript example of constructing a SignedMessage.
4. **Replay Protection**: Nonce must be >=16 cryptographically random bytes (base64url encoded). Timestamp must be within 5 minutes of the broker's clock. The broker maintains an in-memory nonce store and rejects duplicate nonces within the time window.
5. **Validation Rules**: Schema validation (TypeBox compiled validator), base64url pattern enforcement on nonce and public key fields, version literal check.
6. **Versioning**: Current version is `1.0.0`. The `version` field is a `Literal('1.0.0')` -- future versions will add new literals to a union type, allowing the broker to handle multiple versions.
  </action>
  <verify>
All three files exist in `spec/` directory. Each file has the documented sections with TypeScript code examples. Handshake spec documents all 6 denial codes. Identity spec documents base64url wire format with JWK compatibility. Message spec documents the SignedMessage envelope and replay protection rules.
  </verify>
  <done>
Handshake spec documents the full connect() pipeline, all denial codes, grant response format, and post-handshake Neuron flow. Identity spec documents Ed25519 key format, JWK compatibility with Neuron, and signing/verification operations. Message spec documents ConnectRequest schema, SignedMessage envelope, and replay protection rules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write consent and credential spec documents</name>
  <files>
    spec/consent.md
    spec/credential.md
  </files>
  <action>
**spec/consent.md** -- Consent token format specification. IMPORTANT: This is a DESCRIPTIVE spec. Axon does NOT implement, verify, or store consent tokens. Consent is entirely between the patient CareAgent and the Neuron. This document exists so that CareAgent ecosystem developers understand the consent token format that flows through the system.

Sections:
1. **Overview**: Consent tokens represent a patient's authorization for a provider (via their Neuron) to access specific clinical data. Consent tokens are created by the patient CareAgent, verified by the Neuron, and NEVER touch Axon. This spec describes the token format for ecosystem interoperability.
2. **Axon's Role (None)**: Explicitly state that Axon does not verify, store, or inspect consent tokens. The broker's `connect()` checks credentials and endpoint status only. Consent verification happens at the Neuron level during the post-handshake phase (CHALLENGE_RESPONSE step). Reference the Neuron Phase 3 implementation: `ConsentVerifier`, `ConsentHandshakeHandler`.
3. **Token Wire Format**: `{ payload: base64url, signature: base64url }`. Payload is base64url-encoded JSON. Signature is base64url-encoded 64-byte Ed25519 signature. This matches the Neuron ecosystem format from CONTEXT.md.
4. **Token Payload** (informational -- Neuron defines the schema): Describe the expected payload structure as documented in CONTEXT.md. Note that the exact schema is owned by the Neuron implementation; this spec documents it for reference.
5. **Token Lifecycle**: Created by patient CareAgent -> presented to Neuron during handshake -> verified by Neuron using patient's public key -> relationship established. Token is scoped (specifies what data/actions are authorized) and time-limited.
6. **Design Rationale**: Why Axon doesn't touch consent: (a) Axon is trust infrastructure, not clinical infrastructure, (b) storing consent tokens would make Axon a HIPAA covered entity, (c) the "transmits and exits" principle means Axon has no role after the connection grant.

**spec/credential.md** -- Credential format specification. Sections:
1. **Overview**: Provider credentials (licenses, certifications, privileges) are stored in the Axon registry and checked by the broker during connection handshake.
2. **CredentialRecord Schema**: Document the existing `CredentialRecordSchema` from `src/registry/schemas.ts` as the canonical format. Field-by-field: `type` (license | certification | privilege), `issuer` (string), `identifier` (string), `status` (active | pending | expired | suspended | revoked), `issued_at` (optional ISO 8601), `expires_at` (optional ISO 8601), `verification_source` (self_attested | nppes_matched | state_board_verified). Include TypeScript type definition.
3. **Credential Status Lifecycle**: `pending` (initial) -> `active` (verified or accepted) -> `expired` / `suspended` / `revoked` (terminal or reversible). Document which statuses allow connection brokering (only `active`) and which result in denial.
4. **Verification Levels**: `self_attested` (v1 only -- provider claims credential), `nppes_matched` (v2 -- matched against NPPES database), `state_board_verified` (v2 -- confirmed with state licensing board). Note that v1 only uses `self_attested`; the data model supports progressive verification for future versions.
5. **Broker Credential Check**: During `connect()`, the broker checks `entry.credential_status` (the top-level status on the RegistryEntry, not individual credential records). Only `'active'` passes. This is a coarse-grained gate -- individual credential record statuses can be inspected for detailed verification in future versions.
6. **NPI Validation**: Credentials are keyed by NPI. NPI validation uses the Luhn algorithm with 80840 prefix (10-digit format). Reference `src/registry/npi.ts`.
  </action>
  <verify>
Both files exist in `spec/` directory. Consent spec explicitly states Axon's non-involvement and describes the wire format. Credential spec documents the CredentialRecord schema matching `src/registry/schemas.ts` exactly. Both include TypeScript examples where applicable.
  </verify>
  <done>
Consent spec is descriptive-only, explicitly documenting that Axon never touches consent tokens, with the wire format documented for ecosystem reference. Credential spec documents the canonical CredentialRecord schema, credential status lifecycle, verification levels, and the broker's credential check behavior. All five spec/ documents are complete and match the implemented behavior.
  </done>
</task>

</tasks>

<verification>
1. All five files exist: `spec/handshake.md`, `spec/identity.md`, `spec/message.md`, `spec/consent.md`, `spec/credential.md`
2. Each spec document has structured sections with TypeScript code examples
3. Handshake spec covers the full connect() pipeline and all 6 denial codes
4. Identity spec documents base64url wire format and Neuron JWK compatibility
5. Message spec documents ConnectRequest schema and replay protection
6. Consent spec is explicitly descriptive-only (Axon never touches consent)
7. Credential spec matches the CredentialRecord schema from `src/registry/schemas.ts`
8. `pnpm build` still passes (no source code changes in this plan)
</verification>

<success_criteria>
- Five spec documents exist in `spec/` matching the five requirements: handshake (PROT-01), identity (part of PROT-01), message (part of PROT-01), consent (PROT-04), credential (PROT-05)
- All specs describe the implemented behavior (code-first approach -- no spec-code drift)
- Specs use narrative style with TypeScript examples, targeting internal CareAgent developers
- Consent spec explicitly documents Axon's non-involvement in consent verification
- Credential spec matches the existing CredentialRecord TypeBox schema exactly
</success_criteria>

<output>
After completion, create `.planning/phases/04-protocol-specification-and-connection-broker/04-03-SUMMARY.md`
</output>
