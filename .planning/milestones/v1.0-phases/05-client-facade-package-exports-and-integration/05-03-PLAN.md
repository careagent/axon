---
phase: 05-client-facade-package-exports-and-integration
plan: 03
type: execute
wave: 2
depends_on:
  - "05-01"
  - "05-02"
files_modified:
  - tsdown.config.ts
  - package.json
  - test/compatibility-matrix.test.ts
  - test/integration/entry-points.test.ts
autonomous: true
requirements:
  - INTG-01
  - INTG-02
  - INTG-03

must_haves:
  truths:
    - "Every questionnaire action_assignment references an action ID that exists in AxonTaxonomy"
    - "Every questionnaire CANS field mapping is in the VALID_CANS_FIELDS allowlist"
    - "Every entry point (., ./taxonomy, ./questionnaires, ./types, ./mock) exports the documented API surface"
    - "Provider-core can import AxonTaxonomy from @careagent/axon/taxonomy and call getActionsForType('physician') to get valid actions"
    - "Patient-core can import AxonRegistry and AxonBroker from @careagent/axon and use them for provider discovery and connection"
    - "Neuron can import createMockAxonServer from @careagent/axon/mock and run integration tests against it"
    - "The @careagent/axon/mock subpath resolves correctly in package.json exports"
  artifacts:
    - path: "test/compatibility-matrix.test.ts"
      provides: "Cross-validation test suite"
      contains: "Compatibility Matrix"
    - path: "test/integration/entry-points.test.ts"
      provides: "Entry point and consumer integration tests"
      contains: "Entry point exports"
    - path: "package.json"
      provides: "Complete exports map including ./mock subpath"
      contains: "./mock"
    - path: "tsdown.config.ts"
      provides: "Final multi-entry config including mock"
      contains: "src/mock/index.ts"
  key_links:
    - from: "test/compatibility-matrix.test.ts"
      to: "src/taxonomy/taxonomy.ts"
      via: "AxonTaxonomy.validateAction for cross-validation"
      pattern: "validateAction"
    - from: "test/compatibility-matrix.test.ts"
      to: "src/questionnaires/questionnaires.ts"
      via: "AxonQuestionnaires.getForType for all provider types"
      pattern: "getForType"
    - from: "test/integration/entry-points.test.ts"
      to: "@careagent/axon/*"
      via: "package-name imports validating exports map resolution"
      pattern: "@careagent/axon"
    - from: "package.json"
      to: "dist/mock/index.js"
      via: "exports['./mock'].import"
      pattern: '"\./mock"'
---

<objective>
Wire the mock module into the build, create the compatibility matrix test suite, and create integration tests that verify consumer import patterns work correctly.

Purpose: Proves the full compatibility contract -- questionnaire-taxonomy cross-validation, CANS field validity, and that every entry point exports the documented API for provider-core, patient-core, and neuron consumption patterns.

Output: Complete build with all 5 subpath exports working, compatibility matrix test suite passing, and integration tests verifying consumer import patterns.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-client-facade-package-exports-and-integration/05-RESEARCH.md
@.planning/phases/05-client-facade-package-exports-and-integration/05-01-SUMMARY.md
@.planning/phases/05-client-facade-package-exports-and-integration/05-02-SUMMARY.md
@tsdown.config.ts
@package.json
@src/mock/index.ts
@src/taxonomy/taxonomy.ts
@src/questionnaires/questionnaires.ts
@src/questionnaires/cans-fields.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mock entry to build and create compatibility matrix tests</name>
  <files>tsdown.config.ts, package.json, test/compatibility-matrix.test.ts</files>
  <action>
**Step 1: Add mock to build pipeline.**

Update tsdown.config.ts entry array to add `'./src/mock/index.ts'` (append to existing entries from Plan 01).

Update package.json exports to add the `./mock` subpath:
```json
"./mock": {
  "import": "./dist/mock/index.js",
  "types": "./dist/mock/index.d.ts"
}
```

Run `pnpm build` to verify the mock entry builds correctly alongside the other entries.

**Step 2: Create test/compatibility-matrix.test.ts.**

This is a dedicated test suite (separate from module tests) that cross-validates data integrity across all modules. It must cover:

1. **Questionnaire-Taxonomy Cross-Validation:**
   - For every provider type returned by `AxonTaxonomy.getProviderTypes()`:
     - Get the questionnaire via `AxonQuestionnaires.getForType(type.id)`
     - If the questionnaire has questions, iterate all questions and their options
     - For every `action_assignments` entry on any option, validate that `action_id` exists in taxonomy via `AxonTaxonomy.validateAction()`
     - Test assertion message should include the provider type and action ID for debuggability

2. **CANS Field Validation:**
   - For every provider type:
     - Get the questionnaire
     - For every question with a `cans_field`, validate it exists in `VALID_CANS_FIELDS`
     - Test assertion message should include the provider type and field path

3. **Entry Point API Surface Validation:**
   - Dynamic import each built subpath (`dist/index.js`, `dist/taxonomy/index.js`, `dist/questionnaires/index.js`, `dist/types/index.js`, `dist/mock/index.js`)
   - For main entry: verify `Axon`, `AXON_VERSION`, `AxonRegistry`, `AxonBroker`, `AxonTaxonomy`, `AxonQuestionnaires`, `validateNPI`, `generateKeyPair`, `signPayload`, `verifySignature`, `generateNonce` are exported
   - For taxonomy entry: verify `AxonTaxonomy`, `loadTaxonomy`, `TaxonomyVersionSchema` are exported; verify `AxonRegistry` is NOT exported
   - For questionnaires entry: verify `AxonQuestionnaires`, `loadQuestionnaire`, `QuestionnaireSchema` are exported; verify `AxonRegistry` is NOT exported
   - For types entry: verify all type-related exports exist (TaxonomyVersion type availability can be checked via schema presence: `TaxonomyVersionSchema`)
   - For mock entry: verify `createMockAxonServer`, `DEFAULT_FIXTURES` are exported

Import paths for cross-validation tests should use source imports (`../src/taxonomy/taxonomy.js`, etc.) not built imports. The entry point API surface tests should use built imports (`../dist/index.js`, etc.) to verify the actual package output.

IMPORTANT: The entry point tests that import from dist/ require a build to exist. At the top of the entry point API surface describe block, add a `beforeAll` that checks `fs.existsSync('dist/index.js')` and throws an error with message `'dist/ not found — run "pnpm build" before running tests'` if dist/ is absent. Do NOT conditionally skip these tests — they MUST fail hard if dist/ is missing, because a silent skip would let the must_have truth "Every entry point exports the documented API surface" pass vacuously.
  </action>
  <verify>
Run `pnpm build` then `pnpm test`. All compatibility matrix tests must pass. Verify the test output shows the cross-validation, CANS field, and entry point API surface test groups.
  </verify>
  <done>
tsdown.config.ts includes mock entry. package.json exports includes ./mock subpath. test/compatibility-matrix.test.ts passes all cross-validation checks: questionnaire-taxonomy action references resolve, CANS field mappings are valid, and all 5 entry points export their documented API surface.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create consumer integration tests using real consumer packages</name>
  <files>test/integration/entry-points.test.ts</files>
  <action>
Create test/integration/entry-points.test.ts as the consumer integration test suite. This verifies that the three authorized consumers can use Axon as intended by importing from the **real consumer packages** (per locked decision in CONTEXT.md).

**Setup: Link @careagent/axon for package-name resolution.**

Before writing tests, ensure that `@careagent/axon` resolves from within the axon project itself so that imports like `import { AxonTaxonomy } from '@careagent/axon/taxonomy'` work in tests. Run `pnpm link --global` in the axon project root, then `pnpm link --global @careagent/axon` so the package self-resolves. Alternatively, add a `"@careagent/axon": "link:."` entry to `devDependencies` and run `pnpm install` — this is the cleaner approach for a single-repo setup. Choose whichever approach works; the critical requirement is that `import '@careagent/axon/taxonomy'` resolves via the package.json exports map, NOT via source-relative paths.

**All test imports MUST use the `@careagent/axon` package name** (e.g., `@careagent/axon/taxonomy`, `@careagent/axon/mock`, `@careagent/axon/types`) to validate that the package.json exports map, dist file paths, and subpath resolution work correctly for external consumers. Do NOT import from `../src/...` or `../dist/...` source paths.

**1. Provider-core integration (INTG-01):**
```typescript
import { AxonTaxonomy } from '@careagent/axon/taxonomy'

describe('Provider-core: taxonomy consumption', () => {
  it('can get actions for physician type for scope.permitted_actions', () => {
    const actions = AxonTaxonomy.getActionsForType('physician')
    expect(actions.length).toBeGreaterThan(0)
    for (const action of actions) {
      expect(action.id).toMatch(/^[a-z]+(\.[a-z_]+)+$/)
    }
  })

  it('can validate individual action IDs from CANS scope', () => {
    expect(AxonTaxonomy.validateAction('chart.progress_note')).toBe(true)
    expect(AxonTaxonomy.validateAction('nonexistent.action')).toBe(false)
  })

  it('can get provider types for onboarding type selection', () => {
    const types = AxonTaxonomy.getProviderTypes()
    expect(types.length).toBe(49)
  })
})
```

**2. Patient-core integration (INTG-02):**
```typescript
import { AxonRegistry, AxonBroker } from '@careagent/axon'
import { createMockAxonServer } from '@careagent/axon/mock'

describe('Patient-core: provider discovery and connection', () => {
  // Start mock server in beforeAll, stop in afterAll
  it('can search for providers by specialty', () => {
    // Use mock server — GET ${url}/v1/search?specialty=...
  })

  it('can initiate a connection through the broker', () => {
    // Generate Ed25519 key pair, create signed ConnectRequest
    // POST to mock server's /v1/connect endpoint
    // Verify grant response
  })
})
```

**3. Neuron integration (INTG-03):**
```typescript
import { createMockAxonServer } from '@careagent/axon/mock'

describe('Neuron: registration and endpoint management', () => {
  it('can register a neuron', () => {
    // POST /v1/neurons with organization data
  })

  it('can register providers under a neuron', () => {
    // POST /v1/neurons/:id/providers
  })

  it('can update endpoint (heartbeat)', () => {
    // PUT /v1/neurons/:id/endpoint
  })
})
```

For patient-core and neuron tests, use the mock server (`createMockAxonServer`). Start the server in `beforeAll`, stop in `afterAll`.

Use real Ed25519 crypto for the connection test (generate key pair, sign payload, send to broker). This proves the full crypto flow works from a consumer perspective.

Use Node.js built-in `fetch` (available in Node 22) for HTTP requests to the mock server.

**Why this matters:** Importing via `@careagent/axon/taxonomy` (package name) instead of `../src/taxonomy/taxonomy.js` (source path) validates the entire resolution chain: package.json `exports` map -> dist file paths -> subpath resolution. Source-path imports would bypass this completely, making it impossible to catch broken export maps before consumers hit the error.
  </action>
  <verify>
Run `pnpm test`. All integration tests must pass including:
- Provider-core taxonomy consumption tests
- Patient-core search and connect tests (via mock server)
- Neuron registration and endpoint management tests (via mock server)
Verify the test output shows all three consumer integration groups.
  </verify>
  <done>
test/integration/entry-points.test.ts passes all consumer integration tests. Provider-core can consume taxonomy for scope selection. Patient-core can search for providers and initiate connections through the mock server. Neuron can register, manage providers, and heartbeat through the mock server. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` completes with all 5 entry points (., ./taxonomy, ./questionnaires, ./types, ./mock)
2. `pnpm test` passes ALL tests (existing module tests + compatibility matrix + consumer integration)
3. Compatibility matrix confirms: every questionnaire action reference resolves, every CANS field is valid, every entry point exports documented API
4. Provider-core integration: AxonTaxonomy.getActionsForType('physician') returns valid actions for scope selection
5. Patient-core integration: mock server search and connect work correctly
6. Neuron integration: mock server registration and endpoint management work correctly
7. Zero runtime dependencies (no `dependencies` in package.json)
8. `npm pack --dry-run` shows data/ directory included in package
</verification>

<success_criteria>
- Compatibility matrix test suite passes with full cross-validation
- All three consumer integration patterns verified (provider-core, patient-core, neuron)
- All 5 subpath exports build and resolve correctly
- Mock server included in package via @careagent/axon/mock
- Zero runtime dependencies maintained
- All tests pass (existing + new)
</success_criteria>

<output>
After completion, create `.planning/phases/05-client-facade-package-exports-and-integration/05-03-SUMMARY.md`
</output>
