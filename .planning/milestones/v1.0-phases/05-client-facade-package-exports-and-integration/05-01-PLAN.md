---
phase: 05-client-facade-package-exports-and-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/index.ts
  - src/types/index.ts
  - tsdown.config.ts
  - package.json
autonomous: true
requirements:
  - AXON-02
  - AXON-03
  - CLIT-01
  - CLIT-02

must_haves:
  truths:
    - "import { AxonRegistry, AxonBroker, AxonTaxonomy, AxonQuestionnaires } from '@careagent/axon' resolves all four classes"
    - "import { Axon } from '@careagent/axon' provides namespace with Axon.Registry, Axon.Broker, Axon.Taxonomy, Axon.Questionnaires"
    - "import { AxonTaxonomy } from '@careagent/axon/taxonomy' resolves without pulling in registry or broker code"
    - "import { AxonQuestionnaires } from '@careagent/axon/questionnaires' resolves without pulling in registry or broker code"
    - "import type { TaxonomyAction, RegistryEntry, ConnectRequest } from '@careagent/axon/types' resolves with TypeBox schemas available"
    - "pnpm build produces dist/index.js, dist/taxonomy/index.js, dist/questionnaires/index.js, dist/types/index.js with matching .d.ts files"
    - "Published package has zero entries in dependencies field of package.json"
  artifacts:
    - path: "src/index.ts"
      provides: "Axon namespace object + AXON_VERSION + all flat re-exports"
      exports: ["Axon", "AXON_VERSION", "AxonRegistry", "AxonBroker", "AxonTaxonomy", "AxonQuestionnaires"]
    - path: "tsdown.config.ts"
      provides: "Multi-entry build configuration"
      contains: "entry:"
    - path: "package.json"
      provides: "Subpath exports map with import + types conditions"
      contains: "./taxonomy"
  key_links:
    - from: "package.json exports"
      to: "dist/taxonomy/index.js"
      via: "exports['./taxonomy'].import"
      pattern: '"\./taxonomy"'
    - from: "package.json exports"
      to: "dist/questionnaires/index.js"
      via: "exports['./questionnaires'].import"
      pattern: '"\./questionnaires"'
    - from: "package.json exports"
      to: "dist/types/index.js"
      via: "exports['./types'].import"
      pattern: '"\./types"'
    - from: "src/index.ts"
      to: "AxonRegistry, AxonBroker, AxonTaxonomy, AxonQuestionnaires"
      via: "Axon const object"
      pattern: "export const Axon"
---

<objective>
Add the Axon namespace facade object, AXON_VERSION export, and convert the single-entry build to a multi-entry build with subpath exports for taxonomy, questionnaires, and types.

Purpose: Enables consumers to import either the full package or purpose-specific subsets. Provider-core can import only taxonomy, neuron can import only types, and any consumer can use the convenient Axon.Registry / Axon.Taxonomy namespace pattern.

Output: Updated src/index.ts with Axon namespace, multi-entry tsdown config, package.json with subpath exports map, all producing working dist output with declaration files.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-client-facade-package-exports-and-integration/05-RESEARCH.md
@src/index.ts
@src/types/index.ts
@src/taxonomy/index.ts
@src/questionnaires/index.ts
@src/registry/index.ts
@src/protocol/index.ts
@src/broker/index.ts
@tsdown.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Axon namespace facade and AXON_VERSION to src/index.ts, extend types entry</name>
  <files>src/index.ts, src/types/index.ts</files>
  <action>
Update src/index.ts to add the Axon namespace object and version export AFTER the existing barrel re-exports. Keep all existing `export * from` lines unchanged.

Add to src/index.ts:
```typescript
import { AxonRegistry } from './registry/index.js'
import { AxonBroker } from './broker/index.js'
import { AxonTaxonomy } from './taxonomy/index.js'
import { AxonQuestionnaires } from './questionnaires/index.js'

/** Version of the @careagent/axon package */
export const AXON_VERSION = '0.1.0'

/**
 * Convenience namespace object grouping all Axon core classes.
 *
 * @example
 * ```ts
 * import { Axon } from '@careagent/axon'
 *
 * Axon.Taxonomy.getActionsForType('physician')
 * Axon.Questionnaires.getForType('physician')
 * const registry = new Axon.Registry('/tmp/registry.json')
 * ```
 */
export const Axon = {
  Registry: AxonRegistry,
  Broker: AxonBroker,
  Taxonomy: AxonTaxonomy,
  Questionnaires: AxonQuestionnaires,
  version: AXON_VERSION,
} as const
```

The `import` statements for the namespace DO NOT conflict with the `export *` barrel re-exports because `export *` re-exports everything from the module barrel, and the named imports pull in specific classes for the Axon object. TypeScript resolves this correctly.

For src/types/index.ts: Add runtime TypeBox schema re-exports alongside the existing type-only exports. This enables consumers importing `@careagent/axon/types` to get both TypeScript types AND runtime validators for type-safe API interactions. Add the following schema re-exports (keeping ALL existing content):

```typescript
// Runtime TypeBox schemas for consumers needing runtime validation
export {
  TaxonomyVersionSchema,
  TaxonomyActionSchema,
  ProviderTypeSchema,
  AtomicActionSchema,
  GovernedBySchema,
  ProviderTypeCategorySchema,
} from '../taxonomy/schemas.js'

export {
  QuestionnaireSchema,
  QuestionSchema,
  QuestionOptionSchema,
  QuestionConditionSchema,
  ActionAssignmentSchema,
  AnswerTypeSchema,
} from '../questionnaires/schemas.js'

export {
  RegistryEntrySchema,
  NeuronEndpointSchema,
  CredentialRecordSchema,
  OrganizationAffiliationSchema,
  CredentialStatusSchema,
  VerificationSourceSchema,
  EntityTypeSchema,
  RegistrySearchQuerySchema,
} from '../registry/schemas.js'

export {
  ConnectRequestSchema,
  ConnectGrantSchema,
  ConnectDenialSchema,
  DenialCodeSchema,
  SignedMessageSchema,
} from '../protocol/schemas.js'
```

IMPORTANT: The existing type-only re-exports from protocol/schemas.js (`export type { ConnectRequest, ... }`) must remain as `export type` to avoid ambiguous module export errors with src/protocol/index.ts which also exports these. Only add the Schema *value* exports.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors. Run `pnpm test` to confirm existing tests still pass (no regressions from the import additions).
  </verify>
  <done>
src/index.ts exports Axon namespace object and AXON_VERSION. src/types/index.ts re-exports TypeBox schemas alongside existing type exports. All existing tests pass. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure multi-entry tsdown build and package.json subpath exports</name>
  <files>tsdown.config.ts, package.json</files>
  <action>
Update tsdown.config.ts to use multi-entry build:

```typescript
import { defineConfig } from 'tsdown'

export default defineConfig({
  entry: [
    './src/index.ts',
    './src/taxonomy/index.ts',
    './src/questionnaires/index.ts',
    './src/types/index.ts',
  ],
  format: ['es'],
  platform: 'node',
  dts: true,
  clean: true,
  fixedExtension: false,
  inlineOnly: ['@sinclair/typebox'],
})
```

Note: src/mock/index.ts is NOT included yet -- it will be added by Plan 02 after the mock module is created.

Update package.json exports field to include all subpath exports with both `import` and `types` conditions. Keep `main` and `types` top-level fields for backward compatibility:

```json
{
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    },
    "./taxonomy": {
      "import": "./dist/taxonomy/index.js",
      "types": "./dist/taxonomy/index.d.ts"
    },
    "./questionnaires": {
      "import": "./dist/questionnaires/index.js",
      "types": "./dist/questionnaires/index.d.ts"
    },
    "./types": {
      "import": "./dist/types/index.js",
      "types": "./dist/types/index.d.ts"
    }
  }
}
```

Do NOT include `./mock` yet (Plan 02 will add it). Do NOT add any runtime dependencies to `dependencies`. The `devDependencies` section stays unchanged.

After updating both files, run `pnpm build` and verify:
1. dist/index.js and dist/index.d.ts exist
2. dist/taxonomy/index.js and dist/taxonomy/index.d.ts exist
3. dist/questionnaires/index.js and dist/questionnaires/index.d.ts exist
4. dist/types/index.js and dist/types/index.d.ts exist
5. No `dependencies` field in package.json (zero runtime deps)

Then run `pnpm test` to confirm all existing tests still pass.

If tsdown produces unexpected output paths (e.g., flattened names instead of directory structure), investigate tsdown's output behavior with multi-entry and adjust. The key constraint: package.json exports paths must match actual dist output paths.
  </action>
  <verify>
Run `pnpm build` -- must complete without errors. Verify output files exist: `ls dist/index.js dist/index.d.ts dist/taxonomy/index.js dist/taxonomy/index.d.ts dist/questionnaires/index.js dist/questionnaires/index.d.ts dist/types/index.js dist/types/index.d.ts`. Run `pnpm test` -- all existing tests must pass. Run `node -e "import('@careagent/axon')"` style check or `node --input-type=module -e "import('./dist/index.js').then(m => console.log(Object.keys(m).includes('Axon')))"` to confirm Axon namespace is exported.
  </verify>
  <done>
tsdown multi-entry build produces separate chunks for each subpath. package.json exports map routes all four subpaths correctly. Build succeeds. All tests pass. dist output contains all expected .js and .d.ts files.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` completes without errors
2. `pnpm test` passes all existing tests (no regressions)
3. dist/ contains: index.js, index.d.ts, taxonomy/index.js, taxonomy/index.d.ts, questionnaires/index.js, questionnaires/index.d.ts, types/index.js, types/index.d.ts
4. `node --input-type=module -e "import('./dist/index.js').then(m => { console.log('Axon:', !!m.Axon); console.log('version:', m.AXON_VERSION); console.log('Registry:', !!m.AxonRegistry) })"` prints truthy values
5. `node --input-type=module -e "import('./dist/taxonomy/index.js').then(m => console.log('AxonTaxonomy:', !!m.AxonTaxonomy))"` prints truthy
6. package.json has no `dependencies` field
</verification>

<success_criteria>
- Axon namespace object available via `import { Axon } from '@careagent/axon'`
- AXON_VERSION exported from main entry
- Four subpath imports resolve: `.`, `./taxonomy`, `./questionnaires`, `./types`
- Each subpath has both JS and declaration file output
- Zero runtime dependencies maintained
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-client-facade-package-exports-and-integration/05-01-SUMMARY.md`
</output>
