---
phase: 02-questionnaire-repository
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/questionnaires/schemas.ts
  - src/questionnaires/cans-fields.ts
  - src/questionnaires/loader.ts
  - src/questionnaires/questionnaires.ts
  - src/questionnaires/index.ts
  - src/types/index.ts
  - src/index.ts
autonomous: true
requirements:
  - QUES-01
  - QUES-04
  - QUES-05
  - QUES-06

must_haves:
  truths:
    - "TypeBox schema validates questionnaire JSON at load time, rejecting malformed data"
    - "CANS field path allowlist rejects invalid cans_field references"
    - "Loader cross-validates taxonomy action IDs against AxonTaxonomy.validateAction()"
    - "Loader rejects forward-referencing show_when conditions"
    - "AxonQuestionnaires.getForType() returns a questionnaire or undefined"
  artifacts:
    - path: "src/questionnaires/schemas.ts"
      provides: "TypeBox schemas for Questionnaire, Question, QuestionOption, QuestionCondition, ActionAssignment"
      exports: ["QuestionnaireSchema", "QuestionnaireValidator", "QuestionSchema", "AnswerTypeSchema", "QuestionOptionSchema", "QuestionConditionSchema", "ActionAssignmentSchema"]
    - path: "src/questionnaires/cans-fields.ts"
      provides: "CANS field path allowlist"
      exports: ["VALID_CANS_FIELDS"]
    - path: "src/questionnaires/loader.ts"
      provides: "JSON loader with schema + cross-validation"
      exports: ["loadQuestionnaire"]
    - path: "src/questionnaires/questionnaires.ts"
      provides: "AxonQuestionnaires static class with lazy init"
      exports: ["AxonQuestionnaires"]
    - path: "src/questionnaires/index.ts"
      provides: "Module barrel re-exports"
    - path: "src/types/index.ts"
      provides: "Questionnaire derived types"
      contains: "Questionnaire"
    - path: "src/index.ts"
      provides: "Package-level questionnaire re-exports"
      contains: "questionnaires"
  key_links:
    - from: "src/questionnaires/loader.ts"
      to: "src/taxonomy/taxonomy.ts"
      via: "AxonTaxonomy.validateAction() for QUES-05 cross-validation"
      pattern: "AxonTaxonomy\\.validateAction"
    - from: "src/questionnaires/loader.ts"
      to: "src/questionnaires/cans-fields.ts"
      via: "VALID_CANS_FIELDS.has() for QUES-06 validation"
      pattern: "VALID_CANS_FIELDS\\.has"
    - from: "src/questionnaires/questionnaires.ts"
      to: "src/questionnaires/loader.ts"
      via: "loadQuestionnaire() in lazy init"
      pattern: "loadQuestionnaire"
    - from: "src/questionnaires/questionnaires.ts"
      to: "src/taxonomy/taxonomy.ts"
      via: "AxonTaxonomy.getProviderTypes() for provider type enumeration"
      pattern: "AxonTaxonomy\\.getProviderTypes"
    - from: "src/types/index.ts"
      to: "src/questionnaires/schemas.ts"
      via: "Static<typeof Schema> type derivation"
      pattern: "Static<typeof Questionnaire"
---

<objective>
Build the questionnaire module infrastructure: TypeBox schemas, CANS field allowlist, cross-validating loader, and the AxonQuestionnaires static class.

Purpose: Establishes the schema contract (QUES-01), validation pipeline (QUES-05, QUES-06), and public API surface (QUES-04) that Plan 02 will populate with data and test.

Output: Complete `src/questionnaires/` module with schemas, loader, class, and package-level re-exports. Ready to load questionnaire JSON data files.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-questionnaire-repository/02-CONTEXT.md
@.planning/phases/02-questionnaire-repository/02-RESEARCH.md
@src/taxonomy/schemas.ts
@src/taxonomy/loader.ts
@src/taxonomy/taxonomy.ts
@src/taxonomy/index.ts
@src/types/index.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeBox schemas, CANS field allowlist, and derived types</name>
  <files>
    src/questionnaires/schemas.ts
    src/questionnaires/cans-fields.ts
    src/types/index.ts
  </files>
  <action>
Create `src/questionnaires/schemas.ts` following the exact pattern from `src/taxonomy/schemas.ts`:

1. **AnswerTypeSchema**: `Type.Union([Type.Literal('boolean'), Type.Literal('single_select')])` -- per CONTEXT.md locked decision: "Yes/no (boolean) and single-select only. No free-text, no multi-select."

2. **QuestionOptionSchema**: `Type.Object({ value: Type.String(), label: Type.String(), description: Type.Optional(Type.String()) })` -- for single_select questions.

3. **QuestionConditionSchema**: `Type.Object({ question_id: Type.String(), equals: Type.String() })` -- per CONTEXT.md locked decision: "One previous answer drives each condition. No AND/OR."

4. **ActionAssignmentSchema**: `Type.Object({ answer_value: Type.String(), grants: Type.Array(Type.String()) })` -- maps an answer value to taxonomy action IDs to grant. Per CONTEXT.md: "Taxonomy actions are assigned automatically based on questionnaire answers."

5. **QuestionSchema**: `Type.Object({ id: Type.String(), text: Type.String(), answer_type: AnswerTypeSchema, required: Type.Boolean(), options: Type.Optional(Type.Array(QuestionOptionSchema)), show_when: Type.Optional(QuestionConditionSchema), cans_field: Type.String(), action_assignments: Type.Optional(Type.Array(ActionAssignmentSchema)) })` -- note `cans_field` is required (every question maps to a CANS field), `options` and `show_when` and `action_assignments` are optional.

6. **QuestionnaireSchema**: `Type.Object({ provider_type: Type.String(), version: Type.String(), taxonomy_version: Type.String(), display_name: Type.String(), description: Type.String(), questions: Type.Array(QuestionSchema) })` -- root schema. Empty questions array is valid (stubs).

7. **QuestionnaireValidator**: `TypeCompiler.Compile(QuestionnaireSchema)` -- compiled validator for runtime JSON validation.

Export all schemas and the validator. Use the same import pattern as taxonomy/schemas.ts (`import { Type, type Static } from '@sinclair/typebox'`, `import { TypeCompiler } from '@sinclair/typebox/compiler'`).

Create `src/questionnaires/cans-fields.ts`:

Export a `Set<string>` named `VALID_CANS_FIELDS` containing the CANS field paths that questionnaires can populate:
- `'provider.licenses'`
- `'provider.certifications'`
- `'provider.specialty'`
- `'provider.subspecialty'`
- `'provider.organizations'`
- `'scope.permitted_actions'`
- `'scope.taxonomy_version'`
- `'scope.practice_setting'`
- `'scope.supervision_level'`
- `'autonomy.default_level'`
- `'skills.authorized'`

Add a JSDoc comment block explaining this is the contract between Axon questionnaires and provider-core's CANS schema.

Update `src/types/index.ts`:

Add type derivations for the questionnaire schemas, following the existing taxonomy pattern:
```typescript
import type {
  QuestionnaireSchema,
  QuestionSchema,
  QuestionOptionSchema,
  QuestionConditionSchema,
  ActionAssignmentSchema,
  AnswerTypeSchema,
} from '../questionnaires/schemas.js'

export type Questionnaire = Static<typeof QuestionnaireSchema>
export type Question = Static<typeof QuestionSchema>
export type QuestionOption = Static<typeof QuestionOptionSchema>
export type QuestionCondition = Static<typeof QuestionConditionSchema>
export type ActionAssignment = Static<typeof ActionAssignmentSchema>
export type AnswerType = Static<typeof AnswerTypeSchema>
```

Keep all existing taxonomy type exports. Add the new imports alongside existing ones.
  </action>
  <verify>Run `npx tsc --noEmit` from project root -- TypeScript compilation succeeds with zero errors. Verify schemas.ts exports QuestionnaireValidator. Verify types/index.ts exports Questionnaire type.</verify>
  <done>TypeBox schemas define the questionnaire data contract with boolean + single_select answer types only, simple show_when conditions (no compound logic), inline action_assignments, and required cans_field per question. CANS field allowlist contains all valid field paths. All derived types available from types/index.ts.</done>
</task>

<task type="auto">
  <name>Task 2: Create cross-validating loader, AxonQuestionnaires class, and module wiring</name>
  <files>
    src/questionnaires/loader.ts
    src/questionnaires/questionnaires.ts
    src/questionnaires/index.ts
    src/index.ts
  </files>
  <action>
Create `src/questionnaires/loader.ts` following the exact pattern from `src/taxonomy/loader.ts`:

1. **Path resolution**: Use the same walk-up pattern (`fileURLToPath(import.meta.url)` -> `dirname` -> walk up to 4 levels looking for `data/questionnaires/` directory). Resolve individual questionnaire files as `data/questionnaires/{providerTypeId}.json`.

2. **`loadQuestionnaire(providerTypeId: string): Questionnaire`** function that:
   - Resolves the JSON file path using the walk-up pattern
   - Reads and parses the JSON
   - **Step 1 - Schema validation**: Uses `QuestionnaireValidator.Check(data)`. On failure, collect errors via `QuestionnaireValidator.Errors(data)` and throw with descriptive message including provider type ID and error paths.
   - **Step 2 - Taxonomy cross-validation (QUES-05)**: For each question with `action_assignments`, for each assignment's `grants` array, call `AxonTaxonomy.validateAction(actionId)`. Throw on invalid action IDs with message identifying the questionnaire, question ID, and invalid action.
   - **Step 3 - CANS field validation (QUES-06)**: For each question, check `VALID_CANS_FIELDS.has(question.cans_field)`. Throw on invalid CANS field paths with message identifying the questionnaire, question ID, and invalid path.
   - **Step 4 - Show_when forward-reference validation**: Track seen question IDs in a Set. For each question with `show_when`, verify `show_when.question_id` exists in the seen set (must be a PRIOR question). Throw if forward-referencing. Add current question ID to seen set after checking.
   - Return the validated `Questionnaire` object.

Import `AxonTaxonomy` from `'../taxonomy/taxonomy.js'`, `VALID_CANS_FIELDS` from `'./cans-fields.js'`, `QuestionnaireValidator` from `'./schemas.js'`, and `Questionnaire` type from `'../types/index.js'`.

Create `src/questionnaires/questionnaires.ts` following the exact pattern from `src/taxonomy/taxonomy.ts`:

1. **Static class `AxonQuestionnaires`** with:
   - `private static _index: Map<string, Questionnaire> | undefined` -- lazy-loaded index
   - `private static get index(): Map<string, Questionnaire>` -- lazy getter that on first access: gets all provider types from `AxonTaxonomy.getProviderTypes()`, loads each questionnaire via `loadQuestionnaire(type.id)`, builds the Map
   - `static getForType(providerTypeId: string): Questionnaire | undefined` -- returns questionnaire from index or undefined
   - `static listAvailableTypes(): string[]` -- returns all keys from the index

Add JSDoc comments following the same style as AxonTaxonomy (class-level example, method-level @param/@returns).

Create `src/questionnaires/index.ts` barrel file:
```typescript
export {
  AnswerTypeSchema,
  QuestionOptionSchema,
  QuestionConditionSchema,
  ActionAssignmentSchema,
  QuestionSchema,
  QuestionnaireSchema,
  QuestionnaireValidator,
} from './schemas.js'

export { VALID_CANS_FIELDS } from './cans-fields.js'

export { loadQuestionnaire } from './loader.js'

export { AxonQuestionnaires } from './questionnaires.js'
```

Update `src/index.ts` to add questionnaire re-exports:
```typescript
export * from './taxonomy/index.js'
export * from './questionnaires/index.js'
export * from './types/index.js'
```
  </action>
  <verify>Run `npx tsc --noEmit` -- zero errors. Verify `src/questionnaires/loader.ts` imports AxonTaxonomy and VALID_CANS_FIELDS. Verify `src/index.ts` re-exports questionnaires module.</verify>
  <done>Cross-validating loader validates schema, taxonomy action references (QUES-05), CANS field paths (QUES-06), and show_when forward references at load time. AxonQuestionnaires class provides getForType() and listAvailableTypes() with lazy initialization. Module fully wired into package exports.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes -- all TypeScript compiles cleanly
2. `src/questionnaires/schemas.ts` exports QuestionnaireValidator (TypeCompiler.Compile)
3. `src/questionnaires/loader.ts` imports and uses AxonTaxonomy.validateAction() and VALID_CANS_FIELDS.has()
4. `src/types/index.ts` exports Questionnaire, Question, QuestionOption, QuestionCondition, ActionAssignment, AnswerType
5. `src/index.ts` re-exports from questionnaires/index.ts
6. No runtime dependencies added (zero new entries in package.json dependencies)
</verification>

<success_criteria>
- TypeBox schemas enforce: boolean + single_select only, no compound conditions, simple show_when, required cans_field, optional action_assignments
- Loader performs 4-step validation: schema, taxonomy cross-validation, CANS field validation, show_when ordering
- AxonQuestionnaires.getForType() returns Questionnaire | undefined
- All types derived via Static<typeof Schema> (single source of truth)
- Module wired into package exports
</success_criteria>

<output>
After completion, create `.planning/phases/02-questionnaire-repository/02-01-SUMMARY.md`
</output>
