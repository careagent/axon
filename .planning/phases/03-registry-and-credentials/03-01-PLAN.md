---
phase: 03-registry-and-credentials
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/registry/schemas.ts
  - src/registry/npi.ts
  - src/registry/persistence.ts
  - src/registry/index.ts
  - src/types/index.ts
  - test/npi.test.ts
autonomous: true
requirements:
  - REGI-01
  - REGI-02

must_haves:
  truths:
    - "NPI validation rejects non-10-digit strings, non-numeric strings, and strings failing the Luhn check with 80840 prefix"
    - "NPI validation accepts the CMS standard example 1234567893 and other known valid NPIs"
    - "TypeBox schemas define RegistryEntry, NeuronEndpoint, CredentialRecord, OrganizationAffiliation, and RegistrySearchQuery with compiled validators"
    - "verification_source is a REQUIRED field on CredentialRecord (not optional), supporting self_attested, nppes_matched, state_board_verified"
    - "Registry types are exported from src/types/index.ts following the Static<typeof Schema> pattern"
    - "Atomic persistence helpers (persistRegistry, loadRegistry) use write-to-temp-then-rename pattern"
  artifacts:
    - path: "src/registry/schemas.ts"
      provides: "TypeBox schemas for all registry data types"
      contains: "RegistryEntrySchema"
    - path: "src/registry/npi.ts"
      provides: "NPI Luhn validation function"
      exports: ["validateNPI"]
    - path: "src/registry/persistence.ts"
      provides: "Atomic JSON file read/write for registry state"
      exports: ["persistRegistry", "loadRegistry"]
    - path: "src/registry/index.ts"
      provides: "Module barrel export"
    - path: "src/types/index.ts"
      provides: "Registry type exports alongside existing taxonomy and questionnaire types"
      contains: "RegistryEntry"
    - path: "test/npi.test.ts"
      provides: "NPI validation test suite"
      min_lines: 30
  key_links:
    - from: "src/types/index.ts"
      to: "src/registry/schemas.ts"
      via: "Static<typeof Schema> type derivation"
      pattern: "Static<typeof RegistryEntrySchema>"
    - from: "src/registry/persistence.ts"
      to: "src/registry/schemas.ts"
      via: "RegistryEntryValidator for load-time validation"
      pattern: "RegistryEntryValidator\\.Check"
---

<objective>
Create TypeBox schemas for the registry data model, implement NPI validation with the Luhn check digit algorithm, and build atomic file persistence helpers.

Purpose: Establish the foundational types, validation, and persistence that the AxonRegistry class (Plan 02) depends on. These are pure data definitions and pure functions with no mutable state.
Output: Registry schemas, NPI validator, persistence helpers, derived types, and NPI test suite.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-registry-and-credentials/03-RESEARCH.md
@src/taxonomy/schemas.ts
@src/types/index.ts
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Registry TypeBox schemas, NPI validation, and persistence helpers</name>
  <files>
    src/registry/schemas.ts
    src/registry/npi.ts
    src/registry/persistence.ts
    src/registry/index.ts
    src/types/index.ts
  </files>
  <action>
Create `src/registry/schemas.ts` with TypeBox schemas following the established Phase 1/2 pattern (Type.Object, Type.Union of Type.Literal for enums, TypeCompiler.Compile for validators):
- `CredentialStatusSchema`: Union of 'active', 'pending', 'expired', 'suspended', 'revoked'
- `VerificationSourceSchema`: Union of 'self_attested', 'nppes_matched', 'state_board_verified'
- `CredentialTypeSchema`: Union of 'license', 'certification', 'privilege'
- `CredentialRecordSchema`: type, issuer, identifier, status, optional issued_at/expires_at (ISO 8601 strings), REQUIRED verification_source
- `NeuronHealthStatusSchema`: Union of 'reachable', 'unreachable', 'unknown'
- `NeuronEndpointSchema`: url, protocol_version, health_status, optional last_heartbeat
- `OrganizationAffiliationSchema`: organization_npi, organization_name, optional department, optional privileges (string array), optional neuron_endpoint
- `EntityTypeSchema`: Union of 'individual', 'organization'
- `RegistryEntrySchema`: npi, entity_type, name, credential_status, optional provider_types/degrees/specialty/subspecialty (individual fields), optional organization_name/neuron_endpoint (org fields), required credentials array, optional affiliations, registered_at, last_updated, registry_version
- `RegistrySearchQuerySchema`: all optional -- npi, name, specialty, provider_type, organization, credential_status, limit (number), offset (number)
- Compiled validators: RegistryEntryValidator, CredentialRecordValidator, NeuronEndpointValidator, RegistrySearchQueryValidator

Create `src/registry/npi.ts` with `validateNPI(npi: string): boolean`:
- Reject if not exactly 10 digits (regex: /^\d{10}$/)
- Apply Luhn algorithm with constant 24 (accounts for 80840 prefix)
- Process first 9 digits, doubling every other digit starting from rightmost (index 8), subtracting 9 if doubled digit exceeds 9
- Check digit = (10 - (sum % 10)) % 10
- Return true if calculated check digit matches the 10th digit
- IMPORTANT: Validate against CMS example NPI 1234567893 (must return true)

Create `src/registry/persistence.ts` with two functions:
- `persistRegistry(filePath: string, entries: Map<string, RegistryEntry>): void` -- Ensure directory exists (mkdirSync recursive), serialize to JSON with { version: '1.0.0', entries: Object.fromEntries(entries) } pretty-printed, write to temp file in same directory (.registry-{randomUUID()}.tmp), atomic rename via renameSync. All synchronous using node:fs, node:path, node:crypto.
- `loadRegistry(filePath: string): Map<string, RegistryEntry>` -- Return empty Map if file doesn't exist. Parse JSON, validate each entry against RegistryEntryValidator, throw descriptive error on validation failure, return Map.

Create `src/registry/index.ts` barrel export: re-export schemas (all schema exports and validators), npi (validateNPI), persistence (persistRegistry, loadRegistry).

Update `src/types/index.ts` to add registry type exports using Static<typeof Schema> pattern:
- RegistryEntry, NeuronEndpoint, CredentialRecord, OrganizationAffiliation, CredentialStatus, VerificationSource, EntityType, RegistrySearchQuery
- Import from '../registry/schemas.js'

IMPORTANT: This project uses exactOptionalPropertyTypes: true. Optional fields in schemas should use Type.Optional() which maps to `field?: T`. Never assign undefined to optional properties -- use conditional spread or omit the property.
  </action>
  <verify>
Run `pnpm build` -- must compile with zero errors.
Run `pnpm test` -- existing tests must still pass (no regressions).
Verify `src/registry/schemas.ts` exports RegistryEntrySchema, CredentialRecordSchema, NeuronEndpointSchema, RegistrySearchQuerySchema and their compiled validators.
Verify `src/types/index.ts` exports RegistryEntry, CredentialRecord, NeuronEndpoint, OrganizationAffiliation types.
  </verify>
  <done>
TypeBox schemas define all registry data types with compiled validators. NPI validation function implements Luhn algorithm with 80840 prefix. Atomic persistence helpers handle write-to-temp-then-rename and validated loading. Registry types exported from types/index.ts. Build passes with zero errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: NPI validation test suite</name>
  <files>
    test/npi.test.ts
  </files>
  <action>
Create `test/npi.test.ts` with comprehensive NPI validation tests:

describe('validateNPI'):
- Valid NPIs (it.each): '1234567893' (CMS standard example), '1245319599', '1114025222' -- all must return true
- Invalid format (it.each): '' (empty), '12345' (too short), '12345678901' (too long), '123456789a' (non-numeric), 'abcdefghij' (all letters), '123 456 789' (spaces) -- all must return false
- Luhn check failures (it.each): '1234567890', '1234567891', '1234567892', '1111111111', '0000000000' -- valid format but wrong check digit, all must return false

Import from '../src/registry/npi.js' following the existing test import pattern.
  </action>
  <verify>
Run `pnpm test -- test/npi.test.ts` -- all NPI tests pass.
Run `pnpm test` -- full suite passes (no regressions).
  </verify>
  <done>
NPI validation test suite covers valid NPIs (including CMS standard example), invalid formats, and Luhn check failures. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` completes with zero errors
2. `pnpm test` -- all tests pass including new NPI tests and existing taxonomy/questionnaire tests
3. `src/registry/schemas.ts` contains RegistryEntrySchema, CredentialRecordSchema with required verification_source field, NeuronEndpointSchema, RegistrySearchQuerySchema, and compiled validators
4. `src/registry/npi.ts` exports validateNPI that passes CMS example NPI 1234567893
5. `src/registry/persistence.ts` exports persistRegistry and loadRegistry using atomic write pattern
6. `src/types/index.ts` exports RegistryEntry, CredentialRecord, NeuronEndpoint, OrganizationAffiliation types
</verification>

<success_criteria>
- NPI validation accepts CMS example 1234567893 and rejects invalid formats and Luhn failures
- TypeBox schemas compile and produce derived types via Static<typeof Schema>
- Persistence helpers use write-to-temp-then-rename for atomic writes
- Build produces valid dist; all tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/03-registry-and-credentials/03-01-SUMMARY.md`
</output>
