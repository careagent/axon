---
phase: 03-registry-and-credentials
plan: 02
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - src/registry/registry.ts
  - src/registry/index.ts
  - src/index.ts
  - test/registry.test.ts
  - test/registry-persistence.test.ts
autonomous: true
requirements:
  - REGI-03
  - REGI-04
  - REGI-05

must_haves:
  truths:
    - "AxonRegistry supports provider registration with NPI validation, duplicate rejection, and automatic persistence"
    - "AxonRegistry supports Neuron (organization) registration with endpoint configuration"
    - "Credentials attached at registration or via addCredential always have verification_source: 'self_attested'"
    - "Credential status can be updated via updateCredentialStatus, triggering persistence"
    - "Search returns results filtered by NPI (exact), name (case-insensitive substring), specialty (case-insensitive exact), provider_type (exact against array), organization (case-insensitive substring against org name and affiliations), and credential_status (exact), with AND logic for combined queries"
    - "Restarting the process (new AxonRegistry instance with same file path) loads previously persisted state without data loss"
    - "Search supports pagination with limit (default 20, max 100) and offset"
  artifacts:
    - path: "src/registry/registry.ts"
      provides: "AxonRegistry instance class with registration, credential management, search"
      exports: ["AxonRegistry"]
    - path: "src/index.ts"
      provides: "Package root with AxonRegistry re-export alongside AxonTaxonomy and AxonQuestionnaires"
      contains: "registry"
    - path: "test/registry.test.ts"
      provides: "AxonRegistry API tests covering registration, credentials, search"
      min_lines: 100
    - path: "test/registry-persistence.test.ts"
      provides: "Persistence-specific tests: file creation, reload, round-trip integrity"
      min_lines: 40
  key_links:
    - from: "src/registry/registry.ts"
      to: "src/registry/npi.ts"
      via: "NPI validation at registration"
      pattern: "validateNPI"
    - from: "src/registry/registry.ts"
      to: "src/registry/persistence.ts"
      via: "persistRegistry on every mutation, loadRegistry in constructor"
      pattern: "persistRegistry|loadRegistry"
    - from: "src/registry/registry.ts"
      to: "src/registry/schemas.ts"
      via: "Type imports and validator usage"
      pattern: "RegistryEntry|CredentialRecord"
    - from: "src/index.ts"
      to: "src/registry/index.ts"
      via: "Module re-export chain"
      pattern: "from './registry/index.js'"
---

<objective>
Implement the AxonRegistry instance class with provider/Neuron registration, credential management, multi-field search, and file-backed persistence, plus comprehensive test suites.

Purpose: Deliver the complete registry API surface that Phase 4 (Connection Broker) depends on for credential checks and endpoint lookups, and that Phase 5 (Client Facade) exports as the public AxonRegistry class.
Output: Working AxonRegistry class with full test coverage, wired into the package export chain.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-registry-and-credentials/03-RESEARCH.md
@.planning/phases/03-registry-and-credentials/03-01-SUMMARY.md
@src/registry/schemas.ts
@src/registry/npi.ts
@src/registry/persistence.ts
@src/types/index.ts
@src/taxonomy/taxonomy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: AxonRegistry class implementation and module wiring</name>
  <files>
    src/registry/registry.ts
    src/registry/index.ts
    src/index.ts
  </files>
  <action>
Create `src/registry/registry.ts` implementing the AxonRegistry instance class:

**Constructor:** `constructor(filePath: string)` -- stores filePath, calls loadRegistry(filePath) to populate internal `Map<string, RegistryEntry>`.

**registerProvider(registration):** Accepts { npi, name, provider_types: string[], degrees?: string[], specialty?: string, subspecialty?: string, credentials?: Omit<CredentialRecord, 'verification_source'>[], affiliations?: OrganizationAffiliation[] }.
- Validate NPI via validateNPI -- throw Error('Invalid NPI: "{npi}"') on failure
- Check for duplicate NPI -- throw Error('NPI "{npi}" is already registered') if exists
- Validate provider_types against AxonTaxonomy.getProviderTypes() -- throw if any type ID is not in taxonomy (cross-validation per research Open Question 4 recommendation)
- Build RegistryEntry with entity_type: 'individual', credential_status: 'pending', current ISO timestamp for registered_at and last_updated, registry_version: '1.0.0'
- Force verification_source to 'self_attested' on all credentials
- IMPORTANT: Use conditional spread for optional fields to respect exactOptionalPropertyTypes (do NOT set optional fields to undefined)
- Store in Map, call persist(), return the entry

**registerNeuron(registration):** Accepts { npi, name, organization_name, endpoint: NeuronEndpoint, credentials?: Omit<CredentialRecord, 'verification_source'>[] }.
- Same NPI validation and duplicate check as registerProvider
- Build RegistryEntry with entity_type: 'organization'
- Store, persist, return

**findByNPI(npi: string):** O(1) Map.get lookup, return RegistryEntry | undefined.

**addCredential(npi: string, credential: Omit<CredentialRecord, 'verification_source'>):**
- Find entry by NPI -- throw Error('NPI "{npi}" not found') if missing
- Add credential with verification_source: 'self_attested' forced
- Update last_updated, persist

**updateCredentialStatus(npi: string, credentialIdentifier: string, status: CredentialStatus):**
- Find entry -- throw if not found
- Find credential by identifier -- throw Error('Credential "{identifier}" not found for NPI "{npi}"') if missing
- Update status, update last_updated, persist

**updateEndpoint(npi: string, endpoint: NeuronEndpoint):**
- Find entry -- throw if not found, throw if entity_type is not 'organization'
- Update neuron_endpoint, update last_updated, persist

**search(query: RegistrySearchQuery): RegistryEntry[]:**
- Apply limit (default 20, max 100) and offset (default 0)
- Linear scan over Map.values() with AND logic for all provided filter fields:
  - npi: exact match
  - name: case-insensitive substring (entry.name.toLowerCase().includes(query.name.toLowerCase()))
  - specialty: case-insensitive exact match
  - provider_type: exact match against provider_types array (entry.provider_types?.includes(query.provider_type))
  - organization: case-insensitive substring against both entry.organization_name and entry.affiliations[].organization_name
  - credential_status: exact match
- Apply pagination: results.slice(offset, offset + limit)

**Private persist():** Call persistRegistry(this.filePath, this.entries).

Update `src/registry/index.ts` to add AxonRegistry re-export: `export { AxonRegistry } from './registry.js'`

Update `src/index.ts` to add registry module: `export * from './registry/index.js'`
  </action>
  <verify>
Run `pnpm build` -- must compile with zero errors.
Verify AxonRegistry is importable from the package root.
Verify all methods exist on AxonRegistry: registerProvider, registerNeuron, findByNPI, addCredential, updateCredentialStatus, updateEndpoint, search.
  </verify>
  <done>
AxonRegistry class implements all CRUD and search operations with NPI validation, credential management with forced self_attested verification, and atomic persistence on every mutation. Class is wired into the package export chain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Registry and persistence test suites</name>
  <files>
    test/registry.test.ts
    test/registry-persistence.test.ts
  </files>
  <action>
Create `test/registry.test.ts` with comprehensive AxonRegistry API tests. Use temp directories for file isolation (mkdtempSync from node:os + node:fs, cleanup with rmSync in afterEach):

**Registration tests:**
- registerProvider with valid NPI creates entry with entity_type 'individual', credential_status 'pending', correct timestamps
- registerProvider rejects invalid NPI with descriptive error
- registerProvider rejects duplicate NPI with descriptive error
- registerProvider validates provider_types against taxonomy (invalid type throws)
- registerNeuron with valid NPI creates entry with entity_type 'organization', neuron_endpoint set
- registerNeuron rejects invalid NPI

**Credential tests:**
- addCredential forces verification_source to 'self_attested' regardless of input
- addCredential throws for unknown NPI
- Credentials provided at registration also get verification_source 'self_attested'
- updateCredentialStatus changes the status of the specified credential
- updateCredentialStatus throws for unknown NPI
- updateCredentialStatus throws for unknown credential identifier

**Endpoint tests:**
- updateEndpoint updates the neuron_endpoint for an organization entry
- updateEndpoint throws for individual (non-organization) entry
- updateEndpoint throws for unknown NPI

**Search tests:**
- search with no filters returns all entries (up to limit)
- search by NPI returns exact match
- search by name uses case-insensitive substring matching
- search by specialty uses case-insensitive exact match
- search by provider_type matches against provider_types array
- search by organization matches against both organization_name and affiliations
- search by credential_status uses exact match
- search with combined filters uses AND logic
- search with limit and offset returns paginated results
- search with default limit returns max 20 results
- search with limit exceeding 100 is capped at 100
- findByNPI returns undefined for non-existent NPI

Create `test/registry-persistence.test.ts` with persistence-specific tests (separate temp dirs):
- Registry file is created on first registration
- Reloading from same file path restores all entries (create registry1, register provider, create registry2 from same path, verify findByNPI returns the entry)
- Persisted JSON is valid and parseable with version '1.0.0' wrapper
- Loading from non-existent file returns empty registry (no error)
- Credential updates are persisted (add credential, reload, verify credential exists)
- Multiple registrations are all persisted (register 3 providers, reload, verify all 3 exist)

Import AxonRegistry from '../src/registry/registry.js'. Use beforeEach/afterEach for temp directory lifecycle.
  </action>
  <verify>
Run `pnpm test -- test/registry.test.ts` -- all registry API tests pass.
Run `pnpm test -- test/registry-persistence.test.ts` -- all persistence tests pass.
Run `pnpm test` -- full suite passes including existing taxonomy and questionnaire tests.
Run `pnpm test:coverage` -- verify registry module has coverage above 80%.
  </verify>
  <done>
Registry API tests cover registration (provider and Neuron), credential management (add, update status, forced self_attested), endpoint updates, and multi-field search with pagination. Persistence tests verify file creation, round-trip integrity, and state reload. All tests pass. Coverage above 80%.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` completes with zero errors
2. `pnpm test` -- all tests pass (new registry + persistence tests + existing taxonomy + questionnaire tests)
3. `pnpm test:coverage` -- registry module coverage above 80%
4. AxonRegistry registerProvider validates NPI, rejects duplicates, validates provider_types against taxonomy, forces self_attested verification
5. AxonRegistry search supports NPI, name, specialty, provider_type, organization, credential_status with AND logic and pagination
6. Creating a new AxonRegistry instance with the same file path loads previously persisted state
7. AxonRegistry is exported from '@careagent/axon' package root alongside AxonTaxonomy and AxonQuestionnaires
</verification>

<success_criteria>
- AxonRegistry supports full CRUD lifecycle: register, find, add credential, update credential status, update endpoint, search
- Every credential has verification_source: 'self_attested' in v1
- Search supports 6 filter fields with combinable AND logic and pagination
- Persistence survives process restart (new instance loads prior state)
- All tests pass, coverage above 80%, build clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-registry-and-credentials/03-02-SUMMARY.md`
</output>
