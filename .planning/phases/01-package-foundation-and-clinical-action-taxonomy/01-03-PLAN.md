---
phase: 01-package-foundation-and-clinical-action-taxonomy
plan: 03
type: tdd
wave: 3
depends_on:
  - 01-01
  - 01-02
files_modified:
  - src/taxonomy/taxonomy.ts
  - src/taxonomy/index.ts
  - src/index.ts
  - test/taxonomy.test.ts
  - test/taxonomy-data.test.ts
autonomous: true
requirements:
  - TAXO-01
  - TAXO-02
  - TAXO-03
  - TAXO-04
  - TAXO-05

must_haves:
  truths:
    - "AxonTaxonomy.getActionsForType('physician') returns the full Physician action set organized under all 7 atomic actions"
    - "AxonTaxonomy.validateAction('chart.progress_note') returns true; invalid IDs return false"
    - "AxonTaxonomy.getVersion() returns '1.0.0' matching the taxonomy data file version"
    - "AxonTaxonomy.getProviderTypes() returns all 49 provider types"
    - "AxonTaxonomy.getProviderTypesByCategory('medical') returns only medical category types"
    - "Every action in the taxonomy maps to at least one provider type"
    - "Every provider type has at least the common cross-type actions"
    - "pnpm test passes with coverage above 80%"
  artifacts:
    - path: "src/taxonomy/taxonomy.ts"
      provides: "AxonTaxonomy static class with lazy initialization, inverted indexes"
      exports: ["AxonTaxonomy"]
    - path: "test/taxonomy.test.ts"
      provides: "API tests for AxonTaxonomy methods"
      contains: "describe.*AxonTaxonomy"
    - path: "test/taxonomy-data.test.ts"
      provides: "Data integrity tests for taxonomy JSON"
      contains: "describe.*taxonomy data"
  key_links:
    - from: "src/taxonomy/taxonomy.ts"
      to: "src/taxonomy/loader.ts"
      via: "calls loadTaxonomy() for lazy initialization"
      pattern: "loadTaxonomy"
    - from: "src/taxonomy/taxonomy.ts"
      to: "data/taxonomy/v1.0.0.json"
      via: "loads taxonomy JSON via loader at first access"
      pattern: "loadTaxonomy"
    - from: "src/index.ts"
      to: "src/taxonomy/taxonomy.ts"
      via: "exports AxonTaxonomy class"
      pattern: "export.*AxonTaxonomy"
    - from: "test/taxonomy.test.ts"
      to: "src/taxonomy/taxonomy.ts"
      via: "imports and tests AxonTaxonomy API"
      pattern: "import.*AxonTaxonomy"
---

<objective>
Implement the AxonTaxonomy static class with TDD and comprehensive data integrity tests.

Purpose: Create the public API that consumers (provider-core) use to query the taxonomy. TDD ensures the API contract is solid before implementation. Data integrity tests ensure the v1.0.0.json meets all TAXO requirements. This completes Phase 1's taxonomy deliverable.
Output: Working AxonTaxonomy class passing all API and data integrity tests with >80% coverage.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-package-foundation-and-clinical-action-taxonomy/01-RESEARCH.md
@.planning/phases/01-package-foundation-and-clinical-action-taxonomy/01-CONTEXT.md
@.planning/phases/01-package-foundation-and-clinical-action-taxonomy/01-01-SUMMARY.md
@.planning/phases/01-package-foundation-and-clinical-action-taxonomy/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Write failing tests for AxonTaxonomy API and data integrity</name>
  <files>
    test/taxonomy.test.ts
    test/taxonomy-data.test.ts
  </files>
  <action>
Write comprehensive test suites BEFORE implementing the AxonTaxonomy class. Tests must fail initially (RED phase).

**Create `test/taxonomy.test.ts` -- API tests:**

```typescript
import { describe, it, expect } from 'vitest'
import { AxonTaxonomy } from '../src/taxonomy/taxonomy.js'
```

Test cases for the AxonTaxonomy static class API:

1. **getVersion()** (TAXO-03):
   - Returns '1.0.0'
   - Returns a valid semver string

2. **validateAction()** (TAXO-05):
   - Returns true for known action IDs (e.g., 'chart.progress_note', 'order.medication')
   - Returns false for unknown action IDs (e.g., 'chart.made_up_action', 'nonexistent')
   - Returns false for empty string
   - Returns false for partial IDs that don't exactly match (e.g., 'chart' alone is not a leaf action)

3. **getActionsForType()** (TAXO-04):
   - Returns string[] (action IDs) for 'physician'
   - Returns non-empty array for 'physician'
   - Returns action IDs that all pass validateAction()
   - Returns empty array for unknown provider type ID
   - Returns non-empty array for every one of the 49 provider types

4. **getAction()** (supplementary introspection):
   - Returns a TaxonomyAction object for known action ID
   - Returns undefined for unknown action ID
   - Returned object has all required fields (id, atomic_action, display_name, description, applicable_types, governed_by, added_in)

5. **getProviderTypes()** (supplementary introspection):
   - Returns exactly 49 provider types
   - Each has id, display_name, category, member_roles

6. **getProviderTypesByCategory()** (supplementary introspection):
   - Returns only types matching the given category
   - Returns empty array for unknown category
   - 'medical' returns physician, advanced_practice_provider, nursing, nursing_support, pharmacy

7. **getType()** (supplementary introspection):
   - Returns ProviderType for 'physician'
   - Returns undefined for unknown type ID

**Create `test/taxonomy-data.test.ts` -- Data integrity tests:**

Test the actual taxonomy data (not the API, but the data properties):

1. **Structure** (TAXO-07):
   - Taxonomy version is '1.0.0'
   - Taxonomy has a valid effective_date
   - Taxonomy has a description

2. **Provider type completeness** (TAXO-02):
   - Exactly 49 provider types defined
   - No duplicate provider type IDs
   - Every provider type has a non-empty member_roles array
   - Provider type IDs are lowercase_snake_case

3. **Action completeness** (TAXO-01, TAXO-06):
   - Physician has actions under all 7 atomic categories
   - Every action has a dot-notation ID matching its atomic_action prefix
   - Every action has a non-empty description and display_name
   - No duplicate action IDs
   - Every action's atomic_action is one of the 7 valid values

4. **applicable_types integrity** (TAXO-02):
   - Every action has at least one applicable_type
   - Every applicable_type ID is a valid provider type ID defined in the taxonomy
   - Every provider type has at least one action available (no orphan types)

5. **Common cross-type actions** (from CONTEXT.md):
   - Every provider type has chart.progress_note, chart.communication, educate.patient_education, educate.discharge_instructions, coordinate.referral, coordinate.care_transition available

6. **governed_by integrity:**
   - Every action has at least one governed_by entry
   - Every governed_by value is one of: state_board, institution, specialty_board, federal, professional_association

7. **Hierarchy consistency** (TAXO-01):
   - Every action with a `parent` field references an existing action ID
   - Action ID prefixes match their atomic_action field

Define constant arrays for the 7 atomic actions and all 49 provider type IDs at the top of the test file. Use the exact IDs from Plan 02.

Run `pnpm test` -- tests MUST FAIL because AxonTaxonomy class does not exist yet. Commit with message: `test(01-03): add failing tests for AxonTaxonomy API and data integrity`
  </action>
  <verify>
Run `pnpm test` -- must FAIL (AxonTaxonomy not yet implemented). The failure should be import errors or "AxonTaxonomy is not defined" -- not syntax errors. All test files must parse correctly.
  </verify>
  <done>
Two test files exist with comprehensive test cases covering all TAXO requirements. Tests fail because the implementation does not exist yet. Test files have no syntax errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Implement AxonTaxonomy static class and make all tests pass</name>
  <files>
    src/taxonomy/taxonomy.ts
    src/taxonomy/index.ts
    src/index.ts
  </files>
  <action>
Implement the AxonTaxonomy class to make all tests from Task 1 pass (GREEN phase).

**Create `src/taxonomy/taxonomy.ts`:**

Implement a static class with lazy initialization (per RESEARCH.md Pattern 3):

1. Private static fields:
   - `_data: TaxonomyVersion | undefined`
   - `_actionIndex: Map<string, TaxonomyAction> | undefined` -- action ID to full action object
   - `_typeIndex: Map<string, string[]> | undefined` -- provider type ID to array of action IDs
   - `_actionSet: Set<string> | undefined` -- all action IDs for O(1) validateAction

2. Private static getter `data` that triggers lazy load:
   - If `_data` is undefined, call `loadTaxonomy()` from `./loader.js`
   - Call `_buildIndexes()` after loading
   - Return `_data`

3. Private static `_buildIndexes()`:
   - Build `_actionIndex`: `new Map(data.actions.map(a => [a.id, a]))`
   - Build `_actionSet`: `new Set(data.actions.map(a => a.id))`
   - Build `_typeIndex` (inverted index): iterate all actions, for each action iterate its `applicable_types`, accumulate action IDs per provider type ID
   - Use `Map.get()` for all lookups (not plain object indexing -- `noUncheckedIndexedAccess` safe)

4. Public static methods (ALL must have explicit return type annotations for `isolatedDeclarations`):

   - `getVersion(): string` -- returns `data.version`
   - `validateAction(actionId: string): boolean` -- returns `_actionSet.has(actionId)` (O(1))
   - `getActionsForType(providerTypeId: string): string[]` -- returns `_typeIndex.get(providerTypeId) ?? []` (O(1))
   - `getAction(actionId: string): TaxonomyAction | undefined` -- returns `_actionIndex.get(actionId)`
   - `getProviderTypes(): ProviderType[]` -- returns `data.provider_types`
   - `getProviderTypesByCategory(category: string): ProviderType[]` -- returns filtered array
   - `getType(id: string): ProviderType | undefined` -- returns find result

   Each method must access `AxonTaxonomy.data` (via the getter) to trigger lazy initialization before using indexes.

5. Import types from `../types/index.js` for TaxonomyVersion, TaxonomyAction, ProviderType.
   Import `loadTaxonomy` from `./loader.js`.

**Update `src/taxonomy/index.ts`:**
   - Add `export { AxonTaxonomy } from './taxonomy.js'`

**Update `src/index.ts`:**
   - Ensure `export * from './taxonomy/index.js'` includes AxonTaxonomy
   - Ensure `export * from './types/index.js'` exports types

**Handle `exactOptionalPropertyTypes`:** Do NOT assign `undefined` to optional properties. Use omission or conditional construction.

**Handle `noUncheckedIndexedAccess`:** All Map lookups use `.get()` which already returns `T | undefined`. Never use `map[key]` plain object access.

Run `pnpm test` -- ALL tests must PASS. Commit with message: `feat(01-03): implement AxonTaxonomy static class`

Run `pnpm test:coverage` -- coverage must exceed 80% for lines, functions, branches, statements. If coverage is below 80%, identify uncovered paths and add targeted tests.

Run `pnpm build` -- must succeed with zero errors and produce dist/ with AxonTaxonomy exported.
  </action>
  <verify>
Run `pnpm test` -- all tests pass. Run `pnpm test:coverage` -- all thresholds above 80%. Run `pnpm build` -- zero errors. Run `node -e "import('./dist/index.js').then(m => { console.log('Version:', m.AxonTaxonomy.getVersion()); console.log('Physician actions:', m.AxonTaxonomy.getActionsForType('physician').length); console.log('Validate chart.progress_note:', m.AxonTaxonomy.validateAction('chart.progress_note')); console.log('Types:', m.AxonTaxonomy.getProviderTypes().length); })"` -- must output version 1.0.0, >0 physician actions, true for validate, 49 types.
  </verify>
  <done>
AxonTaxonomy static class is implemented and all API and data integrity tests pass. Coverage exceeds 80%. pnpm build succeeds. The taxonomy is fully queryable via getActionsForType, validateAction, getVersion, getProviderTypes, getProviderTypesByCategory, getType, and getAction.
  </done>
</task>

</tasks>

<verification>
1. `pnpm test` passes with all tests green
2. `pnpm test:coverage` shows >80% coverage on lines, functions, branches, statements
3. `pnpm build` succeeds with zero errors
4. `AxonTaxonomy.getActionsForType('physician')` returns action IDs covering all 7 atomic categories
5. `AxonTaxonomy.validateAction('chart.progress_note')` returns true; invalid IDs return false
6. `AxonTaxonomy.getVersion()` returns '1.0.0'
7. `AxonTaxonomy.getProviderTypes()` returns 49 types
8. Every provider type has at least the common cross-type actions
9. Every action maps to at least one provider type
10. Built dist exports AxonTaxonomy class and all types
</verification>

<success_criteria>
- TDD cycle complete: RED (failing tests) -> GREEN (all pass) -> verified
- AxonTaxonomy provides O(1) validateAction via Set, O(1) getActionsForType via inverted Map index
- Full introspection API: getVersion, getActionsForType, validateAction, getAction, getProviderTypes, getProviderTypesByCategory, getType
- Data integrity tests verify TAXO-01 through TAXO-07 properties
- Coverage above 80% for all metrics
- Build produces dist/ with zero runtime deps and all exports functional
</success_criteria>

<output>
After completion, create `.planning/phases/01-package-foundation-and-clinical-action-taxonomy/01-03-SUMMARY.md`
</output>
