---
phase: 05-client-facade-package-exports-and-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mock/index.ts
  - src/mock/server.ts
  - src/mock/fixtures.ts
autonomous: true
requirements:
  - CLIT-03

must_haves:
  truths:
    - "createMockAxonServer() returns a server that starts listening on a dynamic port"
    - "Mock server responds to POST /v1/neurons with 201 and registration_id + bearer_token"
    - "Mock server responds to PUT /v1/neurons/:id/endpoint with 200 for heartbeat"
    - "Mock server responds to POST /v1/neurons/:id/providers with 201 for provider registration"
    - "Mock server responds to DELETE /v1/neurons/:id/providers/:npi with 204 for provider removal"
    - "Mock server responds to GET /v1/neurons/:id with neuron state"
    - "Mock server responds to GET /v1/search with filtered provider search results"
    - "Mock server responds to POST /v1/connect with grant or denial based on credential status"
    - "Mock server is pre-seeded with realistic fixtures (sample providers, valid credentials, taxonomy data)"
    - "Failure scenarios are configurable (expired credentials, connection denial)"
  artifacts:
    - path: "src/mock/index.ts"
      provides: "Mock module subpath entry point"
      exports: ["createMockAxonServer", "MockAxonServer", "MockAxonOptions", "DEFAULT_FIXTURES", "MockFixtures"]
    - path: "src/mock/server.ts"
      provides: "MockAxonServer HTTP server implementation"
      contains: "createMockAxonServer"
    - path: "src/mock/fixtures.ts"
      provides: "Pre-seeded realistic test data"
      exports: ["DEFAULT_FIXTURES"]
  key_links:
    - from: "src/mock/server.ts"
      to: "src/registry/registry.ts"
      via: "AxonRegistry instance for state management"
      pattern: "AxonRegistry"
    - from: "src/mock/server.ts"
      to: "src/broker/broker.ts"
      via: "AxonBroker instance for connect handling"
      pattern: "AxonBroker"
    - from: "src/mock/fixtures.ts"
      to: "src/registry/schemas.ts"
      via: "TypeBox schema validation of fixture data"
      pattern: "RegistryEntryValidator"
---

<objective>
Create the mock Axon HTTP server module with pre-seeded realistic fixtures for consumer integration testing.

Purpose: Enables neuron, provider-core, and patient-core to run integration tests against a realistic Axon server without deploying infrastructure. The mock implements the HTTP API contract that neuron's AxonClient already calls, plus search and connect endpoints for provider-core and patient-core testing.

Output: src/mock/ module with createMockAxonServer(), pre-seeded fixtures, and configurable failure scenarios.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-client-facade-package-exports-and-integration/05-RESEARCH.md
@src/registry/registry.ts
@src/registry/schemas.ts
@src/broker/broker.ts
@src/broker/audit.ts
@src/protocol/identity.ts
@src/protocol/schemas.ts
@/Users/medomatic/Documents/Projects/neuron/test/mock-axon/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mock fixtures with realistic pre-seeded data</name>
  <files>src/mock/fixtures.ts</files>
  <action>
Create src/mock/fixtures.ts with realistic pre-seeded data for integration testing. The fixtures must go through the actual Axon class APIs where possible to ensure schema compliance.

The fixtures should include:

1. **Sample organization (neuron):**
   - Organization NPI: '1234567893' (valid Luhn checksum)
   - Organization name: 'Metro Health System'
   - Organization type: 'health_system'
   - Neuron endpoint URL: 'https://neuron.metrohealth.example.com/v1'

2. **Sample providers (2-3):**
   - Dr. Sarah Chen: NPI '1234567893' (if same as org -- actually use a different valid NPI for the provider, e.g., '1891234560' -- check Luhn validity), physician, specialty 'internal_medicine', credentials active
   - Dr. James Wilson: separate valid NPI, physician, specialty 'surgery', credentials active
   - A provider with expired credentials for testing denial scenarios

3. **Ed25519 key pairs** for signing integration test messages (generate deterministic or on-demand)

4. **Taxonomy data** is NOT fixtures -- it comes from AxonTaxonomy which loads from data/ directory. No need to fixture this.

Export as `DEFAULT_FIXTURES` with a `MockFixtures` type interface:

```typescript
export interface MockFixtures {
  organizations: Array<{
    organization_npi: string
    organization_name: string
    organization_type: string
    neuron_endpoint_url: string
  }>
  providers: Array<{
    npi: string
    name: string
    provider_type: string
    specialty: string
    organization_npi: string
    credentials: Array<{
      credential_type: string
      credential_id: string
      status: string
      issuer: string
      issued_date: string
      expiry_date: string
    }>
  }>
}

export const DEFAULT_FIXTURES: MockFixtures = { ... }
```

Use valid NPI numbers that pass the Luhn check algorithm with 80840 prefix (validate using the existing `validateNPI` function from `../registry/npi.js` during development to confirm). The provider with expired credentials should have `expiry_date` in the past.

IMPORTANT: Keep fixtures minimal but realistic. 1 organization, 2-3 providers is sufficient. Do NOT create elaborate fixture generation factories -- simple const objects.
  </action>
  <verify>
Import the fixtures module and verify it compiles: `npx tsc --noEmit`. Verify NPI values are valid by importing and calling validateNPI on each NPI in the fixtures.
  </verify>
  <done>
src/mock/fixtures.ts exports DEFAULT_FIXTURES with MockFixtures type containing realistic organizations and providers with valid NPIs and credential data. At least one provider has expired credentials for testing denial scenarios.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MockAxonServer HTTP server with route handlers and failure configuration</name>
  <files>src/mock/server.ts, src/mock/index.ts</files>
  <action>
Create src/mock/server.ts implementing the HTTP API contract. The server should:

1. Use Node.js built-in `http` module (no external dependencies)
2. Internally use AxonRegistry (in-memory, no file persistence -- pass a temp file path or use a non-persisting mode) to manage state, ensuring all data goes through schema validation
3. Pre-seed with DEFAULT_FIXTURES on startup
4. Support configurable failure scenarios

**Interface:**

```typescript
export interface MockAxonOptions {
  port?: number           // 0 for dynamic port assignment (default)
  fixtures?: MockFixtures // Override default fixtures
  failureMode?: {
    expiredCredentials?: boolean  // Force credential check failures
    endpointUnavailable?: boolean // Force endpoint lookup failures
  }
}

export interface MockAxonServer {
  readonly url: string
  readonly registry: AxonRegistry
  start(): Promise<string>  // Returns base URL (e.g., 'http://localhost:54321')
  stop(): Promise<void>
}
```

**Routes to implement (matching neuron's AxonClient contract):**

- `POST /v1/neurons` -- Register neuron. Accept `{ organization_npi, organization_name, organization_type, neuron_endpoint_url }`. Return 201 with `{ registration_id, bearer_token, status }`. Internally call `registry.registerNeuron()`.

- `PUT /v1/neurons/:id/endpoint` -- Heartbeat/endpoint update. Accept `{ neuron_endpoint_url? }`. Return 200 with `{ status: 'reachable' }`. Internally call `registry.updateEndpoint()`.

- `POST /v1/neurons/:id/providers` -- Register provider. Accept provider data. Return 201 with `{ provider_id, status: 'registered' }`. Internally call `registry.registerProvider()`.

- `DELETE /v1/neurons/:id/providers/:npi` -- Remove provider. Return 204. (Deregistration not in AxonRegistry v1 -- just return 204 as a no-op for mock compatibility.)

- `GET /v1/neurons/:id` -- Get neuron state. Return 200 with neuron entry from registry.

- `GET /v1/search` -- Provider search. Accept query params `?npi=`, `?name=`, `?specialty=`, `?provider_type=`, `?credential_status=`. Return 200 with `{ results: RegistryEntry[] }`. Internally call `registry.search()`.

- `POST /v1/connect` -- Broker connect. Accept `{ signed_message }` containing a ConnectRequest. Run through AxonBroker.connect() pipeline. Return 200 with grant or 403/400 with denial. If `failureMode.expiredCredentials` is set, force CREDENTIALS_INVALID denial.

For the connect route: Create an AxonBroker instance with the internal registry and an in-memory AuditTrail (using os.tmpdir() for the file path). Use real Ed25519 crypto for signature verification.

**Startup sequence in `start()`:**
1. Create a temp directory for registry persistence
2. Instantiate AxonRegistry with temp file path
3. Load fixtures: for each organization in fixtures, call `registry.registerNeuron()`. For each provider, call `registry.registerProvider()` and `registry.addCredential()`.
4. Create AuditTrail and AxonBroker
5. Start HTTP server on specified port (default 0 for dynamic)
6. Return base URL

**Cleanup in `stop()`:**
1. Close HTTP server
2. Clean up temp files

Create src/mock/index.ts as the subpath entry point:

```typescript
export { createMockAxonServer } from './server.js'
export type { MockAxonServer, MockAxonOptions } from './server.js'
export { DEFAULT_FIXTURES } from './fixtures.js'
export type { MockFixtures } from './fixtures.js'
```

IMPORTANT: Do NOT add the mock entry to tsdown.config.ts or package.json exports yet -- that will be done in Plan 03 after verifying the mock works.

Actually, correction: DO add the mock entry to tsdown.config.ts and package.json in this task so the build includes it. Plan 01 (running in parallel) handles the base entries; this plan needs to ensure mock is also included. Since Plan 01 and Plan 02 both modify tsdown.config.ts and package.json -- WAIT. That creates a file conflict.

RESOLUTION: Do NOT modify tsdown.config.ts or package.json in this plan. Only create the src/mock/ files. Plan 03 (wave 2, depends on both) will add the mock entry to tsdown.config.ts and package.json exports when it wires everything together.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation. Write a minimal test in test/mock-server.test.ts that:
1. Calls `createMockAxonServer()` and `server.start()`
2. Makes a POST request to `${url}/v1/neurons` with sample data
3. Verifies 201 response with registration_id
4. Makes a GET request to `${url}/v1/search?provider_type=physician`
5. Verifies results contain pre-seeded providers
6. Calls `server.stop()`

Run `pnpm test` to confirm all tests pass (existing + new mock test).
  </verify>
  <done>
src/mock/server.ts implements createMockAxonServer() with all HTTP routes matching neuron's contract plus search and connect. src/mock/index.ts provides the subpath entry exports. src/mock/fixtures.ts provides pre-seeded data. Mock server test demonstrates the full API works. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no TypeScript errors
2. `pnpm test` passes all tests (existing + new mock server test)
3. src/mock/index.ts, src/mock/server.ts, src/mock/fixtures.ts all exist
4. Mock server starts, accepts requests on all routes, and returns correct responses
5. Pre-seeded fixtures include realistic providers with valid NPIs and both active and expired credentials
6. Failure modes (expired credentials) are configurable via MockAxonOptions
</verification>

<success_criteria>
- createMockAxonServer() starts an HTTP server pre-seeded with realistic fixtures
- All neuron AxonClient routes implemented (register neuron, heartbeat, register/remove provider, get neuron)
- Search and connect routes implemented for provider-core and patient-core testing
- Configurable failure scenarios for testing error paths
- Mock server test passes demonstrating full API
</success_criteria>

<output>
After completion, create `.planning/phases/05-client-facade-package-exports-and-integration/05-02-SUMMARY.md`
</output>
