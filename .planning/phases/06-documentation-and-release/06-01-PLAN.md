---
phase: 06-documentation-and-release
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/architecture.md
  - docs/protocol.md
  - spec/handshake.md
  - spec/identity.md
  - spec/message.md
  - spec/consent.md
  - spec/credential.md
autonomous: true
requirements:
  - DOCS-01
  - DOCS-02

must_haves:
  truths:
    - "A developer unfamiliar with Axon can read docs/architecture.md and understand the component layers, dependency graph, data flow, and key design decisions"
    - "docs/protocol.md provides a single-page protocol overview that links to all 5 spec documents"
    - "All 5 spec documents have consistent formatting and cross-reference each other where appropriate"
  artifacts:
    - path: "docs/architecture.md"
      provides: "Architecture guide with component layers, dependency graph, data flow, design decisions"
      contains: "stateless broker"
    - path: "docs/protocol.md"
      provides: "Protocol overview linking to 5 spec documents"
      contains: "spec/handshake.md"
  key_links:
    - from: "docs/architecture.md"
      to: "docs/protocol.md"
      via: "relative link"
      pattern: "protocol\\.md"
    - from: "docs/protocol.md"
      to: "spec/handshake.md"
      via: "relative link"
      pattern: "spec/handshake\\.md"
---

<objective>
Create the architecture guide and protocol documentation for Axon.

Purpose: Enable a developer unfamiliar with Axon to understand the component layers, dependency graph, data flow, design decisions, and the protocol specifications that govern the network.

Output: `docs/architecture.md`, `docs/protocol.md`, finalized `spec/*.md` cross-references
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-documentation-and-release/06-RESEARCH.md

# Source structure (document what IS, not what README says)
@src/index.ts
@src/types/index.ts
@src/taxonomy/taxonomy.ts
@src/questionnaires/questionnaires.ts
@src/registry/registry.ts
@src/protocol/identity.ts
@src/broker/broker.ts
@src/broker/audit.ts
@src/mock/server.ts
@spec/handshake.md
@spec/identity.md
@spec/message.md
@spec/consent.md
@spec/credential.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create architecture guide (docs/architecture.md)</name>
  <files>docs/architecture.md</files>
  <action>
Create `docs/` directory and write `docs/architecture.md`. Follow the neuron README style: concise sections, ASCII diagrams, tables, no emoji, no badges.

Structure the document with these sections:

1. **Overview** — One paragraph: Axon is the trust registry, discovery service, and connection broker for the CareAgent ecosystem. It facilitates handshake then exits.

2. **Component Layers** — ASCII diagram showing the 7 source modules and their dependency relationships. Use the exact dependency graph from the research:
   - types/ (schemas + derived types) at the top
   - taxonomy, registry, protocol depend on types/
   - questionnaires depends on taxonomy
   - broker depends on registry + protocol
   - mock uses all modules
   - index.ts (Axon namespace) re-exports all

3. **Module Reference** — Table with one row per module:
   | Module | Key File(s) | Responsibility | Public API |
   Cover: taxonomy (AxonTaxonomy static class, lazy indexes), questionnaires (AxonQuestionnaires, 4-step validation), registry (AxonRegistry, NPI Luhn, atomic persistence), protocol (Ed25519 identity, NonceStore, schemas), broker (AxonBroker.connect() pipeline, AuditTrail), mock (createMockAxonServer), types (TypeBox schemas + derived types)

4. **Data Flow** — ASCII flow diagram for the main path: provider registration -> credential attachment -> patient discovery -> broker connect -> grant/deny. Show which module handles each step.

5. **Package Entry Points** — Table of subpath exports:
   | Entry Point | Import Path | Contains |
   List: `.` (full), `./taxonomy`, `./questionnaires`, `./types`, `./mock`

6. **Mock HTTP Server** — List all HTTP routes (POST /v1/neurons, GET /v1/taxonomy/actions, GET /v1/questionnaires/:typeId, GET /v1/registry/search, GET /v1/registry/:npi, POST /v1/connect, etc.) with brief descriptions. Note that the mock server uses real AxonRegistry and AxonBroker internally.

7. **Design Decisions** — Table documenting the 8 key design decisions from research:
   | Decision | Rationale |
   Cover: stateless broker, data-not-code taxonomy, closed participant list, patient-initiated connections, transmit and exit, zero runtime dependencies, self-attested credentials in v1, hash-chained audit trail.

8. **See Also** — Links to: docs/protocol.md, docs/taxonomy.md, docs/questionnaire-authoring.md, docs/governance.md, CONTRIBUTING.md, spec/ directory.

CRITICAL: Write from source code, NOT from the README. The README has significant drift (wrong file paths, non-existent CLI commands). Every file path and API reference must match the actual implementation.
  </action>
  <verify>
- File exists: `docs/architecture.md`
- Contains ASCII dependency diagram
- Contains module reference table with all 7 modules
- Contains data flow diagram
- Contains all 8 design decisions
- Contains mock server HTTP route list
- All referenced file paths exist in the actual codebase (no `src/client/`, no `src/broker/session.ts`, no `src/broker/handshake.ts`)
  </verify>
  <done>docs/architecture.md exists and accurately describes the implemented component layers, dependency graph, data flow, entry points, mock server routes, and design decisions -- all verified against actual source code</done>
</task>

<task type="auto">
  <name>Task 2: Create protocol overview and finalize spec cross-references</name>
  <files>docs/protocol.md, spec/handshake.md, spec/identity.md, spec/message.md, spec/consent.md, spec/credential.md</files>
  <action>
**Part A: Create `docs/protocol.md`**

Write a protocol overview document that serves as the entry point to the 5 spec documents. Structure:

1. **Overview** — The Axon protocol defines handshake, identity, message format, consent verification, and credential standards. Any two CareAgents implementing the Axon protocol can communicate.

2. **Protocol Documents** — Table linking to all 5 specs:
   | Specification | Path | Describes |
   | Handshake | [spec/handshake.md](../spec/handshake.md) | Connection pipeline, denial codes, grant/denial formats |
   | Identity | [spec/identity.md](../spec/identity.md) | Ed25519 key generation, signing, verification, wire format |
   | Message | [spec/message.md](../spec/message.md) | ConnectRequest schema, SignedMessage envelope, replay protection |
   | Consent | [spec/consent.md](../spec/consent.md) | Consent token format (descriptive-only -- Axon never touches consent) |
   | Credential | [spec/credential.md](../spec/credential.md) | CredentialRecord schema, status lifecycle, verification levels |

3. **Key Properties** — Brief summary of the protocol's defining characteristics: stateless, patient-initiated, signed requests (Ed25519), replay-protected (nonce + timestamp window), credentials-only (no consent verification by broker).

4. **Implementation** — Note that the protocol is fully implemented in `src/protocol/` and `src/broker/`. Point to `docs/architecture.md` for the component layer view.

5. **Versioning** — Protocol version is 1.0.0. Changes follow the governance process described in `docs/governance.md`.

**Part B: Finalize spec cross-references**

For each of the 5 spec documents, make minimal targeted edits:

1. Ensure each spec has a "See Also" section at the bottom (or near the bottom) linking to related specs and back to `docs/protocol.md`. Use relative paths from `spec/` to `docs/` (e.g., `../docs/protocol.md`).

2. Specific cross-references to add (if not already present):
   - handshake.md → identity.md (signing), message.md (request format), credential.md (credential checks)
   - identity.md → message.md (where signatures are used), handshake.md (where identity is verified)
   - message.md → identity.md (signing standard), handshake.md (where messages are processed)
   - consent.md → handshake.md (consent's role in the flow)
   - credential.md → handshake.md (how credentials are checked during connect)

3. Ensure consistent header format across all 5 specs: `# Axon [Topic] Specification` as the H1.

Do NOT rewrite spec content. The specs were written code-first in Phase 4 and are already accurate. Only add cross-reference links and ensure formatting consistency.
  </action>
  <verify>
- File exists: `docs/protocol.md`
- `docs/protocol.md` contains links to all 5 spec documents
- Each spec document has cross-references to related specs
- Each spec document has a link back to `docs/protocol.md`
- No spec content was rewritten (diff shows only additions, not replacements of existing content)
  </verify>
  <done>docs/protocol.md exists as the protocol entry point linking to all 5 specs, and all 5 spec documents have consistent formatting with cross-reference links to related specs and back to the protocol overview</done>
</task>

</tasks>

<verification>
- `docs/` directory exists with `architecture.md` and `protocol.md`
- `docs/architecture.md` contains accurate module structure, dependency graph, and design decisions matching the actual source code
- `docs/protocol.md` links to all 5 spec documents with correct relative paths
- All 5 spec documents cross-reference each other appropriately
- No aspirational content (references to files that do not exist)
</verification>

<success_criteria>
- A developer unfamiliar with Axon can read `docs/architecture.md` and understand the system's component layers, data flow, and design rationale
- `docs/protocol.md` serves as a single entry point to navigate all 5 protocol specifications
- All cross-references between documents resolve to valid files
</success_criteria>

<output>
After completion, create `.planning/phases/06-documentation-and-release/06-01-SUMMARY.md`
</output>
