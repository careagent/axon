---
phase: 05.1-mock-server-http-route-completeness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mock/server.ts
  - test/mock-server.test.ts
  - test/integration/entry-points.test.ts
autonomous: true
requirements: [CLIT-03, REGI-05]

must_haves:
  truths:
    - "GET /v1/taxonomy/actions?type=physician returns full action objects for the physician provider type"
    - "GET /v1/taxonomy/actions without type param returns 400 error"
    - "GET /v1/taxonomy/actions?type=nonexistent returns 404 error"
    - "GET /v1/questionnaires/physician returns the physician questionnaire"
    - "GET /v1/questionnaires/nonexistent returns 404 error"
    - "GET /v1/registry/search?name=Chen returns matching providers (replaces /v1/search)"
    - "GET /v1/registry/search supports limit and offset query params"
    - "GET /v1/registry/1679576722 returns the registry entry for Dr. Sarah Chen"
    - "GET /v1/registry/9999999999 returns 404 for unknown NPI"
    - "Old /v1/search path returns 404 (hard swap)"
  artifacts:
    - path: "src/mock/server.ts"
      provides: "4 new/modified route handlers: taxonomy actions, questionnaire lookup, registry search (renamed), registry NPI lookup"
      contains: "/v1/taxonomy/actions"
    - path: "test/mock-server.test.ts"
      provides: "Tests for all new routes and updated search path references"
      contains: "/v1/registry/search"
    - path: "test/integration/entry-points.test.ts"
      provides: "Updated search path reference"
      contains: "/v1/registry/search"
  key_links:
    - from: "src/mock/server.ts"
      to: "AxonTaxonomy.getActionsForType()"
      via: "import and route handler delegation"
      pattern: "AxonTaxonomy\\.getActionsForType"
    - from: "src/mock/server.ts"
      to: "AxonQuestionnaires.getForType()"
      via: "import and route handler delegation"
      pattern: "AxonQuestionnaires\\.getForType"
    - from: "src/mock/server.ts"
      to: "reg.findByNPI()"
      via: "route handler delegation"
      pattern: "reg\\.findByNPI"
    - from: "src/mock/server.ts"
      to: "reg.search()"
      via: "route handler with limit/offset params"
      pattern: "reg\\.search"
---

<objective>
Add missing taxonomy, questionnaire, and registry HTTP routes to the mock Axon server and migrate the search endpoint path.

Purpose: Close gaps INTG-MOCK-01 (no taxonomy HTTP route), INTG-MOCK-02 (no questionnaire HTTP route), INTG-MOCK-03 (search path mismatch + no direct NPI lookup) so consumers can integration-test all documented operations entirely over HTTP without class imports.

Output: Updated `src/mock/server.ts` with 4 new/modified route handlers, updated test files with new route tests and corrected search path references.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-mock-server-http-route-completeness/05.1-RESEARCH.md
@src/mock/server.ts
@src/mock/fixtures.ts
@test/mock-server.test.ts
@test/integration/entry-points.test.ts
@src/taxonomy/taxonomy.ts
@src/questionnaires/questionnaires.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new route handlers and migrate search path in mock server</name>
  <files>src/mock/server.ts</files>
  <action>
Add two imports at the top of `src/mock/server.ts`, after the existing imports:

```typescript
import { AxonTaxonomy } from '../taxonomy/taxonomy.js'
import { AxonQuestionnaires } from '../questionnaires/questionnaires.js'
```

Then add 3 new route handlers and modify 1 existing route in the `handleRequest()` function. Insert the new routes BEFORE the existing search handler (before the current `// GET /v1/search` block). The ordering matters: place `/v1/registry/search` before `/v1/registry/:npi` so the literal "search" path is not captured by the NPI regex.

**Route 1: GET /v1/taxonomy/actions?type=:providerType** (NEW)
Insert before the search handler. Delegates to `AxonTaxonomy.getActionsForType()` and `AxonTaxonomy.getAction()`.
- If `type` query param is missing, return 400 with `{ error: 'Missing required query parameter: type' }`.
- If provider type does not exist in taxonomy (`AxonTaxonomy.getType(providerType) === undefined`), return 404 with `{ error: 'Unknown provider type: "${providerType}"' }`.
- Otherwise, get action IDs via `AxonTaxonomy.getActionsForType(providerType)`, map each through `AxonTaxonomy.getAction(id)`, filter out undefined, and return 200 with `{ actions: [...fullActionObjects] }`. Return full action objects (not just string IDs) because HTTP consumers don't have access to the class API for follow-up lookups.

**Route 2: GET /v1/questionnaires/:typeId** (NEW)
Insert after the taxonomy route. Uses regex `^\/v1\/questionnaires\/([^/]+)$` to match. Delegates to `AxonQuestionnaires.getForType()`.
- If `getForType(typeId)` returns undefined/null, return 404 with `{ error: 'No questionnaire found for provider type: "${typeId}"' }`.
- Otherwise, return 200 with the questionnaire object directly (not wrapped -- matches the existing pattern of returning direct objects for single resources).

**Route 3: Migrate /v1/search to /v1/registry/search** (MODIFY)
Change the existing search handler:
- Update comment from `// GET /v1/search -- provider search` to `// GET /v1/registry/search -- provider search`
- Change pathname check from `pathname === '/v1/search'` to `pathname === '/v1/registry/search'`
- Add `organization` query param extraction: `const organization = url.searchParams.get('organization') ?? undefined`
- Add `limit` and `offset` query param extraction as numbers: `const limitParam = url.searchParams.get('limit')` and `const offsetParam = url.searchParams.get('offset')`. Parse with `Number()` only when not null.
- Add `organization`, `limit`, and `offset` to the `reg.search()` call using the same conditional spread pattern as existing params.
- Keep the existing `{ results }` response envelope.

**Route 4: GET /v1/registry/:npi** (NEW)
Insert AFTER the registry search handler (critical ordering -- search must match before the regex captures "search" as an NPI). Uses regex `^\/v1\/registry\/([^/]+)$` to match.
- Extract NPI from capture group.
- Call `reg.findByNPI(npi)`. If not found, return 404 with `{ error: 'No registry entry found for NPI: "${npi}"' }`.
- Otherwise, return 200 with the entry directly.

All routes follow existing mock server patterns: `sendJson()` for responses, `{ error: string }` for errors, regex match for parameterized paths, conditional spread for optional query params.
  </action>
  <verify>Run `pnpm build` to confirm TypeScript compilation succeeds with the new imports and route handlers. Build should produce zero errors.</verify>
  <done>
- `src/mock/server.ts` has 2 new imports (AxonTaxonomy, AxonQuestionnaires)
- 4 route handlers present: taxonomy actions, questionnaire lookup, registry search (at new path with pagination), registry NPI lookup
- Old `/v1/search` path no longer exists in the handler
- Route ordering: `/v1/registry/search` appears before `/v1/registry/:npi`
- Build passes with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update test references and add tests for new routes</name>
  <files>test/mock-server.test.ts, test/integration/entry-points.test.ts</files>
  <action>
**Part A: Update search path references in existing tests**

In `test/mock-server.test.ts`, update all 6 occurrences of `/v1/search` to `/v1/registry/search`:
- Line 156: test description `'GET /v1/search?provider_type=physician...'` -> `'GET /v1/registry/search?provider_type=physician...'`
- Line 158: fetch URL `${url}/v1/search?provider_type=physician` -> `${url}/v1/registry/search?provider_type=physician`
- Line 172: test description `'GET /v1/search?specialty=surgery...'` -> `'GET /v1/registry/search?specialty=surgery...'`
- Line 174: fetch URL `${url}/v1/search?specialty=surgery` -> `${url}/v1/registry/search?specialty=surgery`
- Line 187: test description `'GET /v1/search?credential_status=expired...'` -> `'GET /v1/registry/search?credential_status=expired...'`
- Line 189: fetch URL `${url}/v1/search?credential_status=expired` -> `${url}/v1/registry/search?credential_status=expired`

In `test/integration/entry-points.test.ts`, update 1 occurrence:
- Line 63: fetch URL `${url}/v1/search?specialty=internal_medicine` -> `${url}/v1/registry/search?specialty=internal_medicine`

**Part B: Add new route tests to test/mock-server.test.ts**

Add these test cases inside the main `describe('MockAxonServer', ...)` block, after the existing search tests and before the `// --- Connect ---` section:

```typescript
// --- Taxonomy ---

it('GET /v1/taxonomy/actions?type=physician returns full action objects', async () => {
  const res = await fetch(`${url}/v1/taxonomy/actions?type=physician`)

  expect(res.status).toBe(200)
  const data = (await res.json()) as {
    actions: Array<{ id: string; description: string; applicable_types: string[] }>
  }
  expect(data.actions.length).toBeGreaterThan(0)
  // Verify full objects returned (not just string IDs)
  expect(data.actions[0]!.id).toBeTruthy()
  expect(data.actions[0]!.description).toBeTruthy()
  expect(data.actions[0]!.applicable_types).toContain('physician')
})

it('GET /v1/taxonomy/actions without type param returns 400', async () => {
  const res = await fetch(`${url}/v1/taxonomy/actions`)
  expect(res.status).toBe(400)
  const data = (await res.json()) as { error: string }
  expect(data.error).toContain('type')
})

it('GET /v1/taxonomy/actions?type=nonexistent returns 404', async () => {
  const res = await fetch(`${url}/v1/taxonomy/actions?type=nonexistent_type`)
  expect(res.status).toBe(404)
  const data = (await res.json()) as { error: string }
  expect(data.error).toContain('nonexistent_type')
})

// --- Questionnaires ---

it('GET /v1/questionnaires/physician returns the physician questionnaire', async () => {
  const res = await fetch(`${url}/v1/questionnaires/physician`)

  expect(res.status).toBe(200)
  const data = (await res.json()) as {
    provider_type: string
    questions: unknown[]
  }
  expect(data.provider_type).toBe('physician')
  expect(data.questions.length).toBeGreaterThan(0)
})

it('GET /v1/questionnaires/nonexistent returns 404', async () => {
  const res = await fetch(`${url}/v1/questionnaires/nonexistent_type`)
  expect(res.status).toBe(404)
  const data = (await res.json()) as { error: string }
  expect(data.error).toContain('nonexistent_type')
})

// --- Registry Direct Lookup ---

it('GET /v1/registry/:npi returns the registry entry for a known NPI', async () => {
  const res = await fetch(`${url}/v1/registry/1679576722`)

  expect(res.status).toBe(200)
  const data = (await res.json()) as { npi: string; name: string }
  expect(data.npi).toBe('1679576722')
  expect(data.name).toBe('Dr. Sarah Chen')
})

it('GET /v1/registry/:npi returns 404 for unknown NPI', async () => {
  const res = await fetch(`${url}/v1/registry/9999999999`)
  expect(res.status).toBe(404)
  const data = (await res.json()) as { error: string }
  expect(data.error).toContain('9999999999')
})

// --- Search Pagination ---

it('GET /v1/registry/search supports limit and offset params', async () => {
  const res = await fetch(`${url}/v1/registry/search?provider_type=physician&limit=1&offset=0`)

  expect(res.status).toBe(200)
  const data = (await res.json()) as { results: Array<{ npi: string }> }
  expect(data.results.length).toBe(1) // Limited to 1
})
```

Also add a test verifying the old search path returns 404:
```typescript
it('GET /v1/search (old path) returns 404', async () => {
  const res = await fetch(`${url}/v1/search?provider_type=physician`)
  expect(res.status).toBe(404)
})
```

**Part C: Verify no remaining references to old path**

After all changes, grep the project for `/v1/search` to confirm it only appears in planning docs and ROADMAP, not in any `.ts` source or test files.
  </action>
  <verify>Run `pnpm test` -- all tests pass including the new route tests. Then grep for `/v1/search` in `src/` and `test/` directories to confirm zero remaining references to the old path.</verify>
  <done>
- All 6 `/v1/search` references in test/mock-server.test.ts updated to `/v1/registry/search`
- 1 `/v1/search` reference in test/integration/entry-points.test.ts updated to `/v1/registry/search`
- 9 new test cases added: taxonomy actions (happy + 400 + 404), questionnaire (happy + 404), registry NPI lookup (happy + 404), search pagination, old path 404
- All tests pass (existing + new)
- Zero `/v1/search` references remain in src/ and test/ directories
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero errors
2. `pnpm test` passes with all existing + new tests
3. `grep -r '/v1/search' src/ test/` returns zero results (old path fully removed from code)
4. Manual verification of route table in server.ts shows all 10 expected routes:
   - POST /v1/neurons (existing)
   - PUT /v1/neurons/:id/endpoint (existing)
   - POST /v1/neurons/:id/providers (existing)
   - DELETE /v1/neurons/:id/providers/:npi (existing)
   - GET /v1/neurons/:id (existing)
   - GET /v1/taxonomy/actions (NEW)
   - GET /v1/questionnaires/:typeId (NEW)
   - GET /v1/registry/search (RENAMED from /v1/search, with pagination)
   - GET /v1/registry/:npi (NEW)
   - POST /v1/connect (existing)
</verification>

<success_criteria>
- `GET /v1/taxonomy/actions?type=physician` returns 200 with full action objects array
- `GET /v1/questionnaires/physician` returns 200 with the physician questionnaire
- `GET /v1/registry/search?name=Chen` returns 200 with matching providers (module-prefixed path)
- `GET /v1/registry/search?limit=1&offset=0` returns exactly 1 result (pagination works)
- `GET /v1/registry/1679576722` returns 200 with Dr. Sarah Chen's registry entry
- Old `/v1/search` path returns 404 (hard swap complete)
- All existing tests pass unchanged (except path updates)
- Build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-mock-server-http-route-completeness/05.1-01-SUMMARY.md`
</output>
