---
phase: 02-questionnaire-repository
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - data/questionnaires/physician.json
  - data/questionnaires/advanced_practice_provider.json
  - data/questionnaires/nursing.json
  - data/questionnaires/nursing_support.json
  - data/questionnaires/pharmacy.json
  - data/questionnaires/dental.json
  - data/questionnaires/behavioral_mental_health.json
  - data/questionnaires/physical_rehabilitation.json
  - data/questionnaires/occupational_therapy.json
  - data/questionnaires/speech_language.json
  - data/questionnaires/respiratory.json
  - data/questionnaires/audiology.json
  - data/questionnaires/vision_optometry.json
  - data/questionnaires/radiology_imaging.json
  - data/questionnaires/laboratory.json
  - data/questionnaires/surgical.json
  - data/questionnaires/emergency_prehospital.json
  - data/questionnaires/nutrition_dietetics.json
  - data/questionnaires/podiatry.json
  - data/questionnaires/chiropractic.json
  - data/questionnaires/midwifery.json
  - data/questionnaires/genetic_counseling.json
  - data/questionnaires/orthotics_prosthetics.json
  - data/questionnaires/recreational_therapy.json
  - data/questionnaires/creative_arts_therapy.json
  - data/questionnaires/acupuncture_traditional_medicine.json
  - data/questionnaires/massage_bodywork.json
  - data/questionnaires/athletic_training.json
  - data/questionnaires/sleep_medicine.json
  - data/questionnaires/cardiac_vascular_diagnostics.json
  - data/questionnaires/neurodiagnostics.json
  - data/questionnaires/dialysis_nephrology.json
  - data/questionnaires/wound_care.json
  - data/questionnaires/sterile_processing.json
  - data/questionnaires/health_information_coding.json
  - data/questionnaires/community_public_health.json
  - data/questionnaires/home_health_hospice.json
  - data/questionnaires/patient_navigation.json
  - data/questionnaires/lactation.json
  - data/questionnaires/vision_rehabilitation.json
  - data/questionnaires/deaf_hard_of_hearing.json
  - data/questionnaires/anesthesia_technology.json
  - data/questionnaires/clinical_research.json
  - data/questionnaires/organ_tissue.json
  - data/questionnaires/rehabilitation_engineering.json
  - data/questionnaires/kinesiotherapy.json
  - data/questionnaires/child_life.json
  - data/questionnaires/medical_physics.json
  - data/questionnaires/ophthalmic.json
  - test/questionnaires.test.ts
  - test/questionnaire-data.test.ts
autonomous: true
requirements:
  - QUES-02
  - QUES-03
  - QUES-05
  - QUES-06

must_haves:
  truths:
    - "AxonQuestionnaires.getForType('physician') returns a questionnaire with conditional branching and taxonomy-backed action assignments"
    - "AxonQuestionnaires.getForType('nursing') (and all 48 non-Physician types) returns a valid stub with empty questions array"
    - "Every taxonomy action ID in physician questionnaire action_assignments.grants passes AxonTaxonomy.validateAction()"
    - "Every cans_field in every questionnaire passes VALID_CANS_FIELDS validation"
    - "Physician questionnaire has show_when conditions demonstrating conditional branching"
    - "All 49 provider types load without error"
    - "pnpm test passes with >80% coverage"
  artifacts:
    - path: "data/questionnaires/physician.json"
      provides: "Full physician questionnaire with conditional branching and action assignments"
      contains: "show_when"
    - path: "data/questionnaires/nursing.json"
      provides: "Representative stub questionnaire"
      contains: "questions"
    - path: "test/questionnaires.test.ts"
      provides: "AxonQuestionnaires API tests"
      min_lines: 40
    - path: "test/questionnaire-data.test.ts"
      provides: "Data integrity and cross-validation tests"
      min_lines: 60
  key_links:
    - from: "data/questionnaires/physician.json"
      to: "data/taxonomy/v1.0.0.json"
      via: "action_assignments.grants reference taxonomy action IDs"
      pattern: "order\\.laboratory|order\\.imaging|interpret\\.imaging_study|interpret\\.laboratory_result|interpret\\.electrocardiogram|coordinate\\.multidisciplinary_conference|charge\\.evaluation_management"
    - from: "test/questionnaires.test.ts"
      to: "src/questionnaires/questionnaires.ts"
      via: "imports and tests AxonQuestionnaires"
      pattern: "AxonQuestionnaires"
    - from: "test/questionnaire-data.test.ts"
      to: "src/questionnaires/questionnaires.ts"
      via: "loads all 49 types and validates data integrity"
      pattern: "getForType"
---

<objective>
Author the full Physician questionnaire JSON with conditional branching and automatic taxonomy action assignments, generate all 48 stub questionnaire JSONs, and write comprehensive tests covering the AxonQuestionnaires API and data integrity.

Purpose: Populates the questionnaire module (from Plan 01) with real data (QUES-02, QUES-03) and proves cross-validation works (QUES-05, QUES-06) via tests that exercise the full load-validate-query pipeline.

Output: 49 questionnaire JSON data files in `data/questionnaires/`, plus test files that verify all requirements are met.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-questionnaire-repository/02-CONTEXT.md
@.planning/phases/02-questionnaire-repository/02-RESEARCH.md
@.planning/phases/02-questionnaire-repository/02-01-SUMMARY.md
@src/questionnaires/schemas.ts
@src/questionnaires/cans-fields.ts
@src/questionnaires/loader.ts
@src/questionnaires/questionnaires.ts
@src/taxonomy/taxonomy.ts
@data/taxonomy/v1.0.0.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Author Physician questionnaire and generate 48 stub questionnaires</name>
  <files>
    data/questionnaires/physician.json
    data/questionnaires/advanced_practice_provider.json
    data/questionnaires/nursing.json
    data/questionnaires/nursing_support.json
    data/questionnaires/pharmacy.json
    data/questionnaires/dental.json
    data/questionnaires/behavioral_mental_health.json
    data/questionnaires/physical_rehabilitation.json
    data/questionnaires/occupational_therapy.json
    data/questionnaires/speech_language.json
    data/questionnaires/respiratory.json
    data/questionnaires/audiology.json
    data/questionnaires/vision_optometry.json
    data/questionnaires/radiology_imaging.json
    data/questionnaires/laboratory.json
    data/questionnaires/surgical.json
    data/questionnaires/emergency_prehospital.json
    data/questionnaires/nutrition_dietetics.json
    data/questionnaires/podiatry.json
    data/questionnaires/chiropractic.json
    data/questionnaires/midwifery.json
    data/questionnaires/genetic_counseling.json
    data/questionnaires/orthotics_prosthetics.json
    data/questionnaires/recreational_therapy.json
    data/questionnaires/creative_arts_therapy.json
    data/questionnaires/acupuncture_traditional_medicine.json
    data/questionnaires/massage_bodywork.json
    data/questionnaires/athletic_training.json
    data/questionnaires/sleep_medicine.json
    data/questionnaires/cardiac_vascular_diagnostics.json
    data/questionnaires/neurodiagnostics.json
    data/questionnaires/dialysis_nephrology.json
    data/questionnaires/wound_care.json
    data/questionnaires/sterile_processing.json
    data/questionnaires/health_information_coding.json
    data/questionnaires/community_public_health.json
    data/questionnaires/home_health_hospice.json
    data/questionnaires/patient_navigation.json
    data/questionnaires/lactation.json
    data/questionnaires/vision_rehabilitation.json
    data/questionnaires/deaf_hard_of_hearing.json
    data/questionnaires/anesthesia_technology.json
    data/questionnaires/clinical_research.json
    data/questionnaires/organ_tissue.json
    data/questionnaires/rehabilitation_engineering.json
    data/questionnaires/kinesiotherapy.json
    data/questionnaires/child_life.json
    data/questionnaires/medical_physics.json
    data/questionnaires/ophthalmic.json
  </files>
  <action>
First, create the `data/questionnaires/` directory.

**Physician questionnaire (`data/questionnaires/physician.json`):**

Author a complete questionnaire with 10-15 questions covering these clinical scope domains. Per CONTEXT.md: "taxonomy actions are assigned automatically based on questionnaire answers -- the physician never sees or selects action IDs" and "focus on digitally-relevant scope: charting, ordering, interpreting, educating, coordinating."

CRITICAL: Before authoring questions, read `data/taxonomy/v1.0.0.json` to get the exact action IDs available for physicians. Every action ID used in `action_assignments.grants` MUST exist in the taxonomy. Use `AxonTaxonomy.getActionsForType('physician')` conceptually -- reference the actual action IDs from the taxonomy data.

Question structure covering physician scope:

1. **practice_setting** (single_select) -- "What is your primary practice setting?" Options: "academic" (Academic/Teaching), "private" (Private Practice), "hospital" (Hospital-Employed), "government" (Government/Military). Maps to `scope.practice_setting`.

2. **supervision_role** (boolean) -- "Do you supervise residents or fellows?" Show only when practice_setting equals "academic". Maps to `scope.supervision_level`.

3. **clinical_charting** (boolean) -- "Do you document clinical encounters (progress notes, H&P, consultation notes)?" Maps to `scope.permitted_actions`. If true, grants charting actions: chart.progress_note, chart.history_and_physical, chart.consultation_note, chart.communication, chart.referral_letter.

4. **prescribing** (boolean) -- "Do you prescribe medications?" Maps to `scope.permitted_actions`. If true, grants: order.medication, educate.medication_counseling.

5. **controlled_substances** (boolean) -- "Do you prescribe controlled substances (DEA-scheduled)?" Show only when prescribing equals "true". Maps to `scope.permitted_actions`. If true, grants: order.controlled_substance.

6. **diagnostic_ordering** (boolean) -- "Do you order diagnostic tests (lab work, imaging, procedures)?" Maps to `scope.permitted_actions`. If true, grants: order.laboratory, order.imaging, order.procedure.

7. **results_interpretation** (boolean) -- "Do you interpret diagnostic results (lab values, imaging, EKG)?" Maps to `scope.permitted_actions`. If true, grants: interpret.laboratory_result, interpret.imaging_study, interpret.electrocardiogram, interpret.pathology_report.

8. **clinical_procedures** (boolean) -- "Do you perform clinical procedures (injections, biopsies, laceration repair)?" Maps to `scope.permitted_actions`. If true, grants: perform.physical_exam, perform.injection, perform.biopsy, perform.laceration_repair, perform.incision_drainage, perform.suturing, perform.cast_splint.

9. **surgical_practice** (boolean) -- "Does your practice include surgical procedures?" Maps to `scope.permitted_actions`. If true, grants: chart.operative_note, plus the surgical actions available to physicians in the taxonomy (perform.surgical.*).

10. **patient_education** (boolean) -- "Do you provide patient education and discharge planning?" Maps to `scope.permitted_actions`. If true, grants: educate.patient_education, educate.discharge_instructions, educate.informed_consent.

11. **care_coordination** (boolean) -- "Do you coordinate care with other providers (referrals, transitions, team conferences)?" Maps to `scope.permitted_actions`. If true, grants: coordinate.referral, coordinate.care_transition, coordinate.multidisciplinary_conference.

12. **billing** (boolean) -- "Do you submit professional billing/coding?" Maps to `scope.permitted_actions`. If true, grants: charge.evaluation_management, charge.procedure_coding, charge.diagnosis_coding.

All answer values in show_when.equals and action_assignments.answer_value use string "true"/"false" (not JSON booleans). For the single_select practice_setting question, answer_value matches the option value string.

Set root fields: `provider_type: "physician"`, `version: "1.0.0"`, `taxonomy_version: "1.0.0"`, `display_name: "Physician Onboarding Questionnaire"`, `description: "Determines digital scope of practice for Physician (MD, DO) CareAgents"`.

IMPORTANT: Cross-reference EVERY action ID in grants arrays against the actual taxonomy v1.0.0.json. Only use action IDs that exist. The action IDs in the outline above have been verified against v1.0.0.json. The valid action IDs are:
- Charting: chart.progress_note, chart.history_and_physical, chart.consultation_note, chart.communication, chart.referral_letter, chart.operative_note
- Ordering: order.medication, order.controlled_substance, order.laboratory, order.imaging, order.procedure
- Interpreting: interpret.laboratory_result, interpret.imaging_study, interpret.electrocardiogram, interpret.pathology_report
- Performing: perform.physical_exam, perform.injection, perform.biopsy, perform.laceration_repair, perform.incision_drainage, perform.suturing, perform.cast_splint, perform.surgical.*
- Educating: educate.patient_education, educate.medication_counseling, educate.informed_consent, educate.discharge_instructions
- Coordinating: coordinate.referral, coordinate.care_transition, coordinate.multidisciplinary_conference
- Charging: charge.evaluation_management, charge.procedure_coding, charge.diagnosis_coding

**48 Stub questionnaires:**

Get the exact provider type IDs from `data/taxonomy/v1.0.0.json` (the `provider_types` array). For every provider type ID except "physician", create a JSON file at `data/questionnaires/{provider_type_id}.json` with:

```json
{
  "provider_type": "{exact_id}",
  "version": "1.0.0",
  "taxonomy_version": "1.0.0",
  "display_name": "{ProviderType.display_name} Onboarding Questionnaire",
  "description": "Full questionnaire pending clinical domain expert review",
  "questions": []
}
```

Use the `display_name` from the taxonomy data for each provider type. The `provider_type` field must exactly match the `id` field in the taxonomy provider_types array. The file name must be `{id}.json`.

Per CONTEXT.md locked decision: "All 48 non-Physician types get structurally valid stubs with correct metadata and zero questions. Schema-valid, empty questions array -- honest about being stubs."
  </action>
  <verify>Count JSON files in data/questionnaires/ -- should be exactly 49 (1 physician + 48 stubs). Verify physician.json has questions with show_when conditions and action_assignments. Verify a sample stub (nursing.json) has empty questions array. Run `npx tsc --noEmit` to ensure no type issues.</verify>
  <done>49 questionnaire JSON files exist in data/questionnaires/. Physician questionnaire has 10-15 questions with conditional branching (show_when), taxonomy-backed action assignments, and CANS field mappings. All 48 stubs have correct metadata matching taxonomy provider type IDs and empty questions arrays.</done>
</task>

<task type="auto">
  <name>Task 2: Write AxonQuestionnaires API tests and data integrity tests</name>
  <files>
    test/questionnaires.test.ts
    test/questionnaire-data.test.ts
  </files>
  <action>
Create `test/questionnaires.test.ts` -- API contract tests for the AxonQuestionnaires class. Follow the pattern from `test/taxonomy.test.ts`:

```typescript
import { describe, it, expect } from 'vitest'
import { AxonQuestionnaires } from '../src/questionnaires/questionnaires.js'
```

Tests:
1. **getForType('physician') returns a questionnaire** -- not undefined, has provider_type 'physician', has questions array with length > 0
2. **getForType('nursing') returns a stub** -- not undefined, has provider_type 'nursing', questions array has length 0
3. **getForType('nonexistent_type') returns undefined** -- unknown type returns undefined (not throws)
4. **listAvailableTypes() returns all 49 provider types** -- length is 49, includes 'physician', includes 'nursing'
5. **physician questionnaire has conditional questions** -- at least one question has show_when property defined
6. **physician questionnaire has action assignments** -- at least one question has action_assignments with grants array
7. **all questionnaires have valid metadata** -- every type returned by listAvailableTypes() has non-empty provider_type, version, display_name, description
8. **getForType returns consistent results** -- calling getForType('physician') twice returns the same object (lazy init caches)

Create `test/questionnaire-data.test.ts` -- data integrity and cross-validation tests. Follow the pattern from `test/taxonomy-data.test.ts`:

```typescript
import { describe, it, expect } from 'vitest'
import { AxonQuestionnaires } from '../src/questionnaires/questionnaires.js'
import { AxonTaxonomy } from '../src/taxonomy/taxonomy.js'
import { VALID_CANS_FIELDS } from '../src/questionnaires/cans-fields.js'
import { QuestionnaireValidator } from '../src/questionnaires/schemas.js'
```

Tests:
1. **every provider type has a loadable questionnaire** -- iterate `AxonTaxonomy.getProviderTypes()`, call `getForType()` for each, assert not undefined
2. **every questionnaire provider_type matches its lookup key** -- `q.provider_type === typeId` for all types
3. **every questionnaire passes schema validation** -- `QuestionnaireValidator.Check(q)` is true for all loaded questionnaires
4. **physician questionnaire has questions; all stubs have zero** -- physician questions.length > 0; for all others, questions.length === 0
5. **physician questionnaire has conditional branching** -- at least one question with show_when, and the show_when.question_id references a prior question in the array
6. **physician questionnaire assigns taxonomy actions** -- at least one question has action_assignments, total granted action count > 0
7. **all taxonomy action IDs in physician questionnaire are valid (QUES-05)** -- for every action_assignments.grants entry, `AxonTaxonomy.validateAction(actionId)` returns true
8. **all CANS field paths in all questionnaires are valid (QUES-06)** -- for every question in every questionnaire, `VALID_CANS_FIELDS.has(q.cans_field)` is true
9. **all show_when conditions reference prior questions** -- for every questionnaire, verify show_when.question_id appears before the current question in the questions array
10. **all questionnaires have matching taxonomy_version** -- every questionnaire's taxonomy_version matches `AxonTaxonomy.getVersion()`
11. **physician action assignments use string answer values** -- all answer_value fields in action_assignments are strings (not booleans)
12. **no duplicate question IDs within a questionnaire** -- for physician questionnaire, all question IDs are unique

After writing tests, run `pnpm test` to verify all tests pass. Then run `pnpm test:coverage` to verify >80% coverage is maintained. If any tests fail due to data issues, fix the data files first.

Finally, run `pnpm build` to verify the full build still works.
  </action>
  <verify>Run `pnpm test` -- all tests pass. Run `pnpm test:coverage` -- coverage >80% on statements, branches, functions, lines. Run `pnpm build` -- produces dist/ with zero errors.</verify>
  <done>API tests verify AxonQuestionnaires.getForType() returns correct questionnaires for all 49 types, handles unknown types gracefully, and returns physician data with conditional branching and action assignments. Data integrity tests prove QUES-05 (all taxonomy action refs valid), QUES-06 (all CANS field paths valid), show_when ordering, and schema compliance. All tests pass with >80% coverage. Build succeeds.</done>
</task>

</tasks>

<verification>
1. `pnpm test` -- all questionnaire tests pass alongside existing taxonomy tests
2. `pnpm test:coverage` -- coverage >80% on all metrics (statements, branches, functions, lines)
3. `pnpm build` -- build succeeds, dist/ produced
4. 49 JSON files exist in `data/questionnaires/`
5. `physician.json` has >10 questions with show_when conditions and action_assignments
6. Every taxonomy action ID referenced in questionnaire data exists in taxonomy v1.0.0
7. Every cans_field value is in the VALID_CANS_FIELDS allowlist
8. Every stub questionnaire has empty questions array and correct metadata
</verification>

<success_criteria>
- AxonQuestionnaires.getForType('physician') returns questionnaire with conditional branching paths and taxonomy-backed scope selection options
- Every taxonomy action ID referenced in any questionnaire exists in current taxonomy version (QUES-05 proven by test)
- Every CANS field path referenced in questionnaire mappings is valid (QUES-06 proven by test)
- AxonQuestionnaires.getForType('nursing') (and all 48 non-Physician types) returns valid stub with empty questions
- All tests pass, >80% coverage, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-questionnaire-repository/02-02-SUMMARY.md`
</output>
